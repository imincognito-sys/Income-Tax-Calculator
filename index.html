<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Income Tax Calculator FY 2025-26</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel Standalone for JSX transpilation in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js for the comparison chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="importmap">
{
  "imports": {
    "path": "https://aistudiocdn.com/path@^0.12.7",
    "vite": "https://aistudiocdn.com/vite@^7.1.3"
  }
}
</script>
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <script type="text/babel">
        // React and Chart.js are available globally from the CDN scripts above.
        // All application logic from App.tsx and index.tsx is combined here.
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        const { Chart, BarController, BarElement, CategoryScale, LinearScale, Tooltip, Legend } = window.Chart;
        Chart.register(BarController, BarElement, CategoryScale, LinearScale, Tooltip, Legend);

        // --- Start of App.tsx content ---
        const translations = {
          en: {
            appTitle: "Income Tax Calculator",
            appSubtitle: "(Estimates are based on income tax laws as amended by the Finance Act 2025)",
            assesseeProfile: "Assessee Profile",
            yourAgeGroup: "Your Age Group",
            ageBelow60: "Below 60",
            ageSenior: "60 to 80 (Senior)",
            ageSuperSenior: "Above 80 (Super Senior)",
            ageHint: "This affects tax slabs and deduction limits in the Old Regime.",
            usePresumptive: "Use Presumptive Scheme (44AD/ADA)?",
            presumptiveHint: "For professionals or small businesses to declare income at a fixed rate, disabling most deductions.",
            incomeAndGains: "Income & Gains",
            salaryLabel: "Salary (Total Annual)",
            interestIncomeLabel: "Income from Savings Acc. Interest",
            dividendIncomeLabel: "Dividend Income",
            otherIncomeLabel: "Other Income",
            otherIncomeTooltip: "Debt income includes interest received from various instruments like Bond Interest, Debt MF income, Debt ETFs, Liquid Funds,corporate bond, Money Market funds, FD, NRI Accounts(NRE/FCNR), Government Securities, T-Bills",
            agriculturalIncomeLabel: "Net Agricultural Income",
            agriculturalIncomeTooltip: "As per Sec 10(1), this income is exempt from tax. However, if it exceeds ₹5,000 and your total non-agricultural income is above the basic exemption limit, it is used to calculate your tax rate under the Old Regime.",
            agriculturalIncomeNote: "Affects tax rates in Old Regime only if conditions are met.",
            howAgriIsCalculated: "How is this calculated?",
            agriTaxImpactLabel: "Effective tax increase due to aggregation:",
            agriTaxModalTitle: "Understanding Tax on Agricultural Income",
            agriTaxModalIntro: "Your agricultural income itself is NOT taxed. However, when it's over ₹5,000 and your other income is taxable, the government uses it to determine a higher tax rate on your normal income. This process is called the 'method of aggregation'.",
            agriTaxModalStep1: "Step 1: Calculate tax on your combined income.",
            agriTaxModalStep2: "Step 2: Calculate tax on your agricultural income + the basic tax-free slab.",
            agriTaxModalStep3: "Step 3: Subtract Step 2 from Step 1.",
            agriTaxModalFinalTax: "Your final tax on normal income is the result. This ensures you pay tax on your normal income at a rate that reflects your total financial status.",
            agriTaxModalNormalIncome: "Your Normal Taxable Income",
            agriTaxModalAgriIncome: "Your Agricultural Income",
            agriTaxModalCombinedIncome: "A. Total for Tax Calculation",
            agriTaxModalTaxOnCombined: "Tax on (A)",
            agriTaxModalBasicExemption: "Basic Tax Exemption Limit",
            agriTaxModalBaseForStep2: "B. Base for Rate Calculation",
            agriTaxModalTaxOnBase: "Less: Tax Rebate on Base Amount (B)",
            agriTaxModalRebateExplanation: "This is a tax relief calculated on the base slab. It is subtracted to ensure that your agricultural income itself is not directly taxed.",
            agriTaxModalFinalResult: "Final Slab Tax (A - B)",
            closeButton: "Close",
            taxableGiftsLabel: "Taxable Gifts Received",
            taxableGiftsTooltip: "Enter the total value only if it exceeds ₹50,000 from non-relatives during the financial year. Gifts from specified relatives (e.g., parents, spouse, siblings) or received for your marriage are not taxable and should not be entered here.",
            taxableGiftsNote: "Note: As per income tax rules, amounts up to ₹50,000 will be considered non-taxable and will not be added to your income.",
            businessProfessionLabel: "Business/Profession Income",
            ltcgLabel: "LTCG (12.5%)",
            ltcgTooltip: "Arise from sale of capital assets like stocks, properties etc., held for a period of more than 24 months (12 months in case of listed shared and equity funds). The tax rate on Long Term Capital Gains is 12.5% for all capital assets. However, for listed equity shares, equity-oriented funds, and units of business trusts, the LTCG exceeding Rs. 1.25 lakh will be taxed flat at 12.5%.",
            stcgLabel: "STCG (20%)",
            stcgTooltip: "Arise when assets are transferred within the specified holding period i.e., within 12 months for listed equity shares and units of equity-oriented mutual funds or 24 months for other assets. Under Section 111A, short-term capital gains tax on listed equity shares and equity-oriented mutual funds is 20%. All other assets like real estate, unlisted shares, gold, etc., are taxed at applicable income tax slab rates.",
            cryptoGainsLabel: "Gains from Crypto/VDA (30% flat)",
            salaryDetailsTitle: "Salary Details & HRA (Old Regime)",
            salaryDetailsHint: "The fields below are auto-filled based on your total Salary. You can edit them manually. HRA exemption is calculated using Basic + DA.",
            salaryBreakdown: "Salary Breakdown",
            basicSalaryLabel: "Basic Salary",
            daLabel: "Dearness Allowance (DA)",
            hraReceivedLabel: "HRA Received",
            ltaLabel: "Leave Travel Allowance (LTA)",
            specialAllowanceLabel: "Special Allowance",
            bonusLabel: "Bonus",
            calculatedTotal: "Calculated Total from Breakdown:",
            mismatchWarning: "(Mismatch with Total Salary!)",
            hraExemptionPlanner: "HRA Exemption Planner",
            rentPaidLabel: "Total Annual Rent Paid",
            metroCityLabel: "Live in a metro city? (Delhi, Mumbai, Chennai, Kolkata)",
            calculatedHraExemption: "Calculated HRA Exemption:",
            showCalculation: "Show calculation",
            hideCalculation: "Hide calculation",
            hraLowestOf: "HRA exemption is the lowest of the following:",
            actualHraReceived: "1. Actual HRA Received:",
            rentOver10pcSalary: "2. Rent Paid - 10% of Salary:",
            salaryPercentageCap: "3. {percentage}% of Salary (for {cityType}):",
            metro: "Metro",
            nonMetro: "Non-Metro",
            otherSalaryDeductions: "Other Salary Deductions",
            professionalTaxLabel: "Professional Tax (Max ₹2,500)",
            ltaExemptionTitle: "Leave Travel Allowance (LTA) Exemption (Old Regime Only)",
            ltaExemptionHint: "Claim exemption for up to two domestic journeys in a block of 4 years (current block: 2022-25). Exemption is the lower of LTA received and actual travel fare.",
            journeysClaimedLabel: "Number of Journeys Claimed This Year",
            eligibleTravelExpensesLabel: "Eligible Travel Expenses (Fare only)",
            fareHint: "e.g., Economy airfare or 1st AC rail fare.",
            calculatedLtaExemption: "Calculated LTA Exemption:",
            ltaLowestOf: "LTA exemption is the lowest of the following:",
            ltaReceivedFromEmployer: "1. Actual LTA Received from Employer:",
            eligibleTravelExpenses: "2. Eligible Travel Expenses (Fare only):",
            incomeFromHousePropertyTitle: "Income from House Property (Sec 22-27)",
            propertyLabel: "Property {index}",
            removeButton: "REMOVE",
            propertyStatusLabel: "Property Status",
            sopOption: "Self-Occupied (SOP)",
            lopOption: "Let-Out / Deemed Let-Out (LOP)",
            sopWarning: "Warning: Max 2 SOPs allowed. This property will not be counted for SOP tax benefits.",
            calculateGAVToggle: "Calculate GAV Accurately?",
            detailedGAVTitle: "Detailed GAV Calculation",
            municipalValueLabel: "Municipal Value",
            municipalValueTooltip: "The value of your property as per municipal records.",
            fairRentLabel: "Fair Rent",
            fairRentTooltip: "The rent a similar property in the same locality would fetch.",
            standardRentLabel: "Standard Rent",
            standardRentTooltip: "The rent fixed under the Rent Control Act, if applicable.",
            actualRentLabel: "Actual Rent Received",
            actualRentTooltip: "The total rent you actually received or are entitled to receive.",
            gavSummaryTitle: "GAV Calculation Summary",
            gavSummaryMV: "1. Municipal Value:",
            gavSummaryFR: "2. Fair Rent:",
            gavSummaryHigher1: "3. Higher of (1) and (2):",
            gavSummarySR: "4. Standard Rent:",
            gavSummaryER: "5. Expected Rent (Lower of (3) and (4)):" ,
            gavSummaryAR: "6. Actual Rent Received:",
            gavSummaryFinal: "7. Gross Annual Value (GAV) (Higher of (5) and (6)):",
            gavLabel: "Gross Annual Value (GAV) / Rent Received",
            gavTooltip: "Gross Annual Value is the rent a property might fetch in a year. Use the accurate calculator for precision, or enter the total rent received.",
            municipalTaxesLabel: "Municipal Taxes Paid by Owner",
            municipalTaxesTooltip: "Must be paid by the owner during the year to be deductible.",
            lopInterestLabel: "Interest on Home Loan (u/s 24(b))",
            lopInterestHint: "No limit on deduction against rental income.",
            preConInterestLabel: "Pre-Construction Interest (1/5th)",
            preConInterestTooltipLOP: "Enter 1/5th of the total interest paid on your loan for the period before construction was completed. This is your annual deductible installment for pre-construction interest.",
            preConInterestHint: "Annual instalment of pre-construction interest.",
            sopInterestLabel: "Interest on Home Loan (u/s 24(b))",
            sopInterestHint: "Deductible loss capped at {cap}.",
            loanTypePurchase: "For Purchase/Construction (Post-1999)",
            loanTypeRepair: "For Repairs / Pre-1999",
            preConInterestTooltipSOP: "This is 1/5th of the total interest paid on your loan during the period before construction was completed. This amount is added to the current year's interest, and the total deduction is subject to the overall SOP limit (₹2,00,000 or ₹30,000). Not applicable for repair loans.",
            sopPreConInterestHint: "Added to main interest, subject to the same cap.",
            sopRemainingAllowance: "Remaining available for deduction: {amount}",
            sopTotalInterestClaimed: "Total Interest Deduction Claimed:",
            addPropertyButton: "+ Add Another Property",
            broughtForwardLossLabel: "Brought-Forward Loss from House Property (Old Regime Only)",
            broughtForwardLossTooltip: "Loss from house property that couldn't be set-off in previous years can be carried forward for up to 8 years and set-off against current year's house property income.",
            broughtForwardLossHint: "Set-off against HP income of current year.",
            netTaxableHPOld: "Net Taxable HP (Old Regime):",
            netTaxableHPNew: "Net Taxable HP (New Regime):",
            showFullCalculation: "({toggle} Full Calculation)",
            hide: "Hide",
            show: "Show",
            hpBreakdownTitle: "Property {index} ({type}) Calculation",
            hpBreakdownGAV: "A. Gross Annual Value (GAV):",
            hpBreakdownMunicipalTaxes: "B. Less: Municipal Taxes Paid:",
            hpBreakdownNAV: "C. Net Annual Value (NAV) (A - B):",
            hpBreakdownStdDed: "D. Less: Standard Deduction (30% of NAV):",
            hpBreakdownInterest: "E. Less: Interest on Loan:",
            hpBreakdownIncomeLoss: "F. Income / (Loss) from this Property:",
            hpBreakdownSOPInterest: "A. Total Interest on Home Loan:",
            hpBreakdownSOPLoss: "B. Allowable Loss (capped at {cap}):",
            hpBreakdownSOPNote: "{note}",
            hpFinalCalcTitle: "Final Aggregated Calculation (Old Regime)",
            hpFinalCalcCurrentYear: "G. Current Year Total Income / (Loss) from HP:",
            hpFinalCalcBFLoss: "H. Less: Brought-Forward Loss Set-off:",
            hpFinalCalcTotalIncomeLoss: "I. Total Income / (Loss) from HP this year:",
            hpFinalCalcCappedNote: "Note: Total loss from house property that can be set-off against other income is limited to ₹2,00,000 per year.",
            hpFinalCalcNetAmount: "J. Net Amount for Old Regime GTI:",
            npsContributionsTitle: "NPS Contributions",
            npsIndividualContributionLabel: "Individual NPS Contribution 80CCD(1)",
            npsIndividualContributionTooltip: "The Section 80CCD(1) provides a maximum deduction of 10% of the employee’s salary (basic + DA) contributed in the previous year towards NPS. The maximum limit of deductions is capped at ₹1.5 lakhs for a given financial year.",
            npsIndividualContributionHint: "This deduction is only available under the Old Regime and capped at ₹1.5 lakhs.",
            npsVoluntaryLabel: "Your Voluntary Contribution (80CCD1B)",
            npsVoluntaryHint: "Your personal, extra contribution. Deductible under Old Regime only. Max ₹50,000.",
            npsEmployerLabel: "Employer's Contribution (80CCD2)",
            npsEmployerHint: "Contribution made by your company. Deductible under Old & New Regimes.",
            npsEmployerLimitNote: "Based on your Basic + DA, you are eligible for a maximum deduction of {amount}.",
            agniveerTitle: "Agniveer Scheme Contributions (80CCH)",
            agniveerTooltip: "Individuals aged between 17.5 years to 21 years who are enrolled in the Agnipath Scheme on or after November 1, 2022.",
            agniveerYourContributionLabel: "Your Contribution to Agniveer Corpus Fund",
            agniveerYourContributionHint: "Deductible under Old Regime only.",
            agniveerGovtContributionLabel: "Central Govt's Contribution to Your Fund",
            agniveerGovtContributionHint: "Added to income, then deductible under both Regimes.",
            deductionsTitle: "Deductions under Chapter VI-A (Old Regime)",
            ded80CLabel: "80C (Max ₹1,50,000)",
            sharedLimitNote: "You have claimed {claimedVal} under section {claimedSec}. The maximum amount that can be claimed under section {otherSec} is now {limitVal} (i.e., ₹1,50,000 - {claimedVal}).",
            sharedLimitNoteInitial: "You have claimed {claimedVal} under section {claimedSec}. The maximum amount that can be claimed under section {otherSec} is now {limitVal} (i.e., ₹1,50,000 - {claimedVal}).",
            ded80DLabel: "80D (Health Insurance) (Max {amount})",
            ded80GLabel: "80G (Donations)",
            ded80TTALabel: "80TTA/TTB (Savings Int.) (Max {amount})",
            ded80ELabel: "80E (Education Loan Int.)",
            ded80GGLabel: "80GG (Rent, Max ₹60,000)",
            ded80ULabel: "80U (Disability)",
            ded80UNone: "Not Applicable",
            ded80UNormal: "Disability (₹75,000)",
            ded80USevere: "Severe Disability (₹1,25,000)",
            ded80DDBLabel: "80DDB (Medical Treat.) (Max {amount})",
            prepaidTaxesTitle: "Pre-paid Taxes",
            tdsLabel: "TDS",
            tcsLabel: "TCS",
            advanceTaxLabel: "Advance Tax/ Self Assesment Tax",
            summaryTitle: "Comparison Summary",
            suggestedRegime: "Suggested Regime:",
            oldRegimeTitle: "Old Regime",
            newRegimeTitle: "New Regime",
            grossIncomeLabel: "Gross Income:",
            hpIncomeLossLabel: "Income/(Loss) from HP:",
            gtiLabel: "Gross Total Income:",
            stdDedLabel: "Standard Deduction:",
            hraExemptionLabel: "HRA Exemption:",
            ltaExemptionLabel: "LTA Exemption:",
            profTaxLabel: "Professional Tax:",
            employerNPSLabel: "Employer's NPS (80CCD2):",
            ded80CCD1Label: "NPS Contribution (80CCD1):",
            voluntaryNPSLabel: "Voluntary NPS (80CCD1B):",
            yourAgniveerLabel: "Your Agniveer Contribution:",
            govtAgniveerLabel: "Govt's Contribution to Agniveer:",
            chapVIADedLabel: "Other Deductions (Chap VI-A):",
            taxableIncomeLabel: "Taxable Income:",
            prepaidTaxesLabel: "Prepaid Taxes:",
            finalCalcTitle: "Final Tax Calculation",
            taxOnNormalIncome: "Tax on Normal Income:",
            showBreakup: "({toggle} breakup)",
            totalSlabTax: "Total Slab Tax:",
            noSlabTax: "No tax applicable on slab income.",
            taxOnLTCG: "Tax on LTCG (12.5%):",
            taxOnSTCG: "Tax on STCG (20%):",
            taxOnCrypto: "Tax on Crypto (30%):",
            taxBeforeSurcharge: "Total Tax before Surcharge:",
            surchargeLabel: "Surcharge (@ {rate}%):",
            marginalReliefLabel: "Less: Marginal Relief:",
            taxBeforeCess: "Tax Before Cess:",
            cessLabel: "Cess (4%):",
            totalTaxPayable: "Total Tax Payable:",
            lessTDS: "Less: TDS",
            lessTCS: "Less: TCS",
            lessAdvanceTax: "Less: Advance Tax",
            totalPrepaidTax: "Total Prepaid Tax:",
            netPayable: "Net Payable",
            refund: "Refund",
            taxSavingOppsTitle: "Tax Saving Opportunities",
            plannerDisabledPresumptive: "Planner is disabled for the presumptive scheme.",
            plannerEnterIncome: "Enter your income details above to see personalized tax-saving opportunities.",
            plannerNoLiability: "You have no tax liability under either regime. Well done! Here's a summary of the deductions that helped you achieve this.",
            oldRegimePlannerTitle: "Old Regime Planner",
            potentialSaving: "By maximizing your available deductions, you could save an additional {amount}.",
            potentialLiability: "Your total tax liability could be as low as {amount}.",
            currentSavingPicture: "Your Current Tax-Saving Picture (Old Regime)",
            totalExemptionClaimed: "Total Exemption Claimed:",
            totalDeductionClaimed: "Total Deductions Claimed:",
            deductionsIncludeNote: "(Incl. Std. Deduction, 80C, 80D, etc.)",
            maximizedDeductions: "You have maximized all major available deductions. Great job!",
            remainingPotential: "Here's your remaining potential:",
            potential80CCE: "Contribute {amount} more under <strong>Section 80C / 80CCD(1)</strong>.",
            potential80CCENote: "This deduction is part of the ₹1.5 lakh limit under Sec 80CCE (along with 80C and 80CCD(1) combined).",
            potentialNPS: "Invest {amount} more in <strong>NPS (80CCD1B)</strong>.",
            potential80D: "Claim up to {amount} more for <strong>Health Insurance (80D)</strong>.",
            potential80TTA: "Claim up to {amount} more for <strong>Savings Interest (80TTA/TTB)</strong>.",
            potentialProfTax: "Claim up to {amount} more for <strong>Professional Tax</strong>.",
            conditionalSavingsTitle: "Conditional Savings Opportunities",
            conditionalSavingsHint: "These deductions depend on your specific circumstances. Select them to see the potential impact.",
            opp80GG: "<strong>Rent without HRA (80GG):</strong> Claim up to an additional {amount}.",
            opp80GGHint: "Applicable if you pay rent but don't receive HRA.",
            opp80GGDisabled: "(Disabled as you receive HRA)",
            opp80DDB: "<strong>Medical Treatment (80DDB):</strong> Claim up to an additional {amount}.",
            opp80DDBHint: "For treatment of specified diseases for self/dependents.",
            opp80E: "<strong>Education Loan (80E):</strong> If you are paying interest on an education loan, you can claim the full interest amount as a deduction with no upper limit. Enter this amount in the 'Deductions' section above to see its effect.",
            newRegimeOppsTitle: "New Regime Opportunities",
            newRegimeOppsPicture: "Your Current Tax-Saving Picture (New Regime)",
            newRegimeOppsDeductionsIncludeNote: "(Incl. Std. Deduction, Employer's NPS & Agniveer)",
            newRegimeOppsSummary: "The New Regime offers limited deductions. Here is a summary of what has been applied:",
            newRegimeOppsStdDed: "<strong>Standard Deduction:</strong> A deduction of {amount} has been applied to your salary.",
            newRegimeOppsNPS: "<strong>Employer's NPS Contribution (80CCD2):</strong> You have claimed {amount}.",
            newRegimeOppsAgniveer: "<strong>Agniveer Scheme (80CCH):</strong> You have claimed a total of {amount}.",
            newRegimeOppsNote: "These are the primary deductions available to reduce tax under the New Regime. Most other deductions are not applicable.",
            oppsNPSNewRegimeTitle: "<strong>NPS Contribution (80CCD2):</strong> You may be eligible for tax savings. Please check with your employer.",
            oppsNPSNewRegimeTooltip: "Assessee can be Government Employee (or) Non Government Employee. Self employed assessees are not eligible for this deduction.\n\nDeduction Limits:\n• Central / State Government Employer: 14% of salary (Basic + DA)\n• Other Employer:\n  - Old Regime: 10% of salary (Basic + DA)\n  - New Regime: 14% of salary (Basic + DA)",
            oppsNPSNewRegimeNote: "Note: Employer contribution of up to 14% of Salary (Basic and DA) towards NPS is eligible for tax deduction under section 80CCD(2) to the extent of ₹7.5 lakh* in the New Tax Regime. Kindly note the limit of ₹7.5 lakh is cumulative of Employer contribution to EPF, Superannuation and NPS.",
            itrFormTitle: "Suggested ITR Form",
            itrFormReasonAgri: "Required for reporting agricultural income over ₹5,000.",
            totalTaxComparisonTitle: "Income & Tax Insight",
            insightTooltip: "The insight is a simulation to help users understand potential scenarios, though it may not exactly reflect real outcomes. The Standard Deduction is included under <i>‘Deduction & Exemption’</i> since it is regulated by the Government and may change with each budget. This emphasizes that taxpayers have limited control over it, and its inclusion is intended to simplify both the visual representation and the calculation.",
            insightTax: "You are paying <strong>{months} months</strong> of your income as direct tax.",
            insightDeductions: "You are consuming <strong>{months} months</strong> of your income as Deduction & Exemptions.",
            insightTakeHome: "You have <strong>{months} months</strong> of your income left after tax to manage your yearly expenses.",
            chartLabelTax: "Total Tax",
            chartLabelReductions: "Deductions & Exemptions",
            chartLabelPostTax: "Post-Taxation Income",
            taxSlabRatesTitle: "Tax Slab Rates (Finance Act 2025)",
            toggleTaxSlabTables: "{toggle} Tax Slab Tables",
            oldTaxRegimeTitle: "Old Tax Regime",
            incomeSlab: "Income Slab (₹)",
            below60Col: "Below 60",
            seniorCol: "60 to 80 (Senior)",
            superSeniorCol: "Above 80 (Super Senior)",
            slabNil: "Nil",
            oldRegimeNotesTitle: "Notes:",
            newRegimeNotesTitle: "Notes:",
            surchargeNotesTitle: "Note:",
            oldRegimeNote1: "<strong>Standard Deduction:</strong> ₹50,000 on Salary Income.",
            oldRegimeNote2: "<strong>Tax Rebate (u/s 87A):</strong> Full tax rebate if Taxable Income is up to ₹5,00,000.",
            oldRegimeNote3: "<strong>Health & Education Cess:</strong> 4% on tax amount (including surcharge, if any).",
            newTaxRegimeTitle: "New Tax Regime (Default)",
            taxRateCol: "Tax Rate",
            newRegimeNote1: "<strong>Standard Deduction:</strong> ₹75,000 on Salary Income.",
            newRegimeNote2: "<strong>Tax Rebate (u/s 87A):</strong> Full tax rebate if Taxable Income is up to ₹12,00,000.",
            newRegimeNote3: "<strong>Health & Education Cess:</strong> 4% on tax amount (including surcharge, if any).",
            surchargeTitle: "Surcharge & Marginal Relief",
            toggleSurchargeTables: "{toggle} Surcharge Tables",
            surchargeHint: "Surcharge is an additional tax levied on income tax for high-income earners. <strong>Marginal Relief</strong> ensures that the increase in tax due to surcharge does not exceed the actual increase in income above the surcharge threshold.",
            netTaxableIncomeLimitCol: "Net Taxable Income Limit",
            surchargeOldCol: "Surcharge (Old Regime)",
            surchargeNewCol: "Surcharge (New Regime)",
            surchargeNote: "The surcharge on tax payable on dividend income and certain capital gains is capped at 15%. This calculator applies the general slab rates for simplification.",
            slabOldRow1: "Up to 2,50,000",
            slabOldRow2: "2,50,001 - 3,00,000",
            slabOldRow3: "3,00,001 - 5,00,000",
            slabOldRow4: "5,00,001 - 10,00,000",
            slabOldRow5: "Above 10,00,000",
            slabNewRow1: "Up to 4,00,000",
            slabNewRow2: "4,00,001 - 8,00,000",
            slabNewRow3: "8,00,001 - 12,00,000",
            slabNewRow4: "12,00,001 - 16,00,000",
            slabNewRow5: "16,00,001 - 20,00,000",
            slabNewRow6: "20,00,001 - 24,00,000",
            slabNewRow7: "Above 24,00,000",
            surchargeRow1: "Less than ₹50 lakhs",
            surchargeRow2: "More than ₹50 lakhs to ₹1 Crore",
            surchargeRow3: "More than ₹1 Crore to ₹2 Crore",
            surchargeRow4: "More than ₹2 Crore to ₹5 Crore",
            surchargeRow5: "More than ₹5 Crore",
            rate5pc: "5%",
            rate10pc: "10%",
            rate15pc: "15%",
            rate20pc: "20%",
            rate25pc: "25%",
            rate30pc: "30%",
            rate37pc: "37%",
            
            yourSavingIs: "Your Saving is {amount} if you choose the {regime}.",
            
            footerAdvisoryTitle: "Advisory",
            footerAdvisoryText: "Information relates to the law prevailing in the year of publication/ as indicated. Viewers are advised to ascertain the correct position/prevailing law before relying upon any document.",
            footerDisclaimerTitle: "Disclaimer",
            footerDisclaimerText: "This Calculator is provided for educational and informational purposes only. While every effort has been made to ensure accuracy, the Developer makes no representations or warranties - express or implied - regarding the correctness, completeness, reliability, or suitability of the results for actual tax filing. Users are strongly advised to consult a qualified Chartered Accountant or tax professional before making any financial or tax-related decisions. The Developer shall not be held responsible for any errors, omissions, misinterpretations, or financial losses arising from reliance on this tool.",
            
            footerCopyrightHeader: "Copyright © 2025, Income Tax Calculator. All Rights Reserved.",
            footerCopyrightWarning: "Unauthorized copying, reproduction, distribution, modification, reverse engineering, or use of this Calculator or its underlying code - without the explicit written consent of the Developer - is strictly prohibited and constitutes copyright infringement under the Copyright Act, 1957 (Sections 51, 55, 63 & 63A).",
            footerInfringementTitle: "Any person found infringing these rights may be subject to:",
            footerCriminalLiability: "Criminal liability - imprisonment of up to three years and/or fines ranging from ₹50,000 to ₹200,000 (Sections 63 & 63A).",
            footerCivilRemedies: "Civil remedies - including injunctions, damages, accounts of profits, seizure, and destruction of infringing material (Sections 55 & 56).",
            footerPermissionNotice: "For any permitted use, please obtain prior written consent from the Developer.",
            
            footerDeveloperContactTitle: "Developer Contact:",
            footerDeveloperContactInfo: "Indrajit Mondal |",

            footerGoverningLawTitle: "Governing Law",
            footerGoverningLawText: "This notice shall be governed by and construed in accordance with the laws of India. Any disputes shall be subject to the exclusive jurisdiction of the courts of Asansol, West Bengal, India.",
            
            footerPrivacyHeader: "Privacy Policy: We respect your privacy — this calculator does not collect or store any data.",
            footerPrivacyPoint1Title: "1. No Data Collection",
            footerPrivacyPoint1Text: "This Calculator does not collect, store, or share any personal or financial data entered by users. All calculations are performed locally in your browser.",
            footerPrivacyPoint2Title: "2. No Tracking",
            footerPrivacyPoint2Text: "We do not use cookies, analytics tools, or third-party trackers to monitor your activity.",
            footerPrivacyPoint3Title: "3. Data Security",
            footerPrivacyPoint3Text: "Since no data is collected or stored, there is no risk of your financial details being accessed, shared, or compromised through this Calculator.",
            footerPrivacyPoint4Title: "4. Updates",
            footerPrivacyPoint4Text: "We may update this Privacy Policy from time to time. Any changes will be reflected on this page.",
            
            footerTermsHeader: "Terms & Conditions",
            footerTermsIntro: "By accessing and using this Income Tax Calculator (“Calculator”), you agree to the following Terms & Conditions. If you do not agree, please discontinue use immediately.",
            footerTerms1Title: "1. Purpose of the Calculator",
            footerTerms1Point1: "This Calculator is provided solely for educational and informational purposes.",
            footerTerms1Point2: "It is not intended to replace professional tax advice or official tax computation tools provided by the Government of India.",
            footerTerms1Point3: "Users are advised to consult a qualified Chartered Accountant or tax professional before filing returns or making financial decisions.",
            footerTerms2Title: "2. User Obligations",
            footerTerms2Point1: "You agree to use this Calculator only for lawful and personal purposes.",
            footerTerms2Point2: "You must not attempt to copy, modify, reverse engineer, or commercially exploit the Calculator without the prior written consent of the Developer.",
            footerTerms3Title: "3. Intellectual Property",
            footerTerms3Point1: "© 2025 Income Tax Calculator — All Rights Reserved · Developed by Indrajit Mondal.",
            footerTerms3Point2: "All content, design, code, and features are protected under the Copyright Act, 1957 (India). Unauthorized use is strictly prohibited and may invite legal action.",
            footerTerms4Title: "4. Disclaimer of Liability",
            footerTerms4Point1: "The results provided by this Calculator are estimates only and may not reflect actual tax liabilities in all scenarios.",
            footerTerms4Point2: "The Developer makes no warranties regarding accuracy, completeness, or suitability of the results.",
            footerTerms4Point3: "The Developer shall not be held responsible for any direct, indirect, incidental, or consequential losses arising from use of this Calculator.",
            footerTerms5Title: "5. Limitation of Liability",
            footerTerms5Point1: "By using this Calculator, you acknowledge that:",
            footerTerms5Point2: "The Developer is not liable for any loss of income, data, or business opportunities resulting from use of the Calculator.",
            footerTerms5Point3: "Use of this Calculator does not create any professional-client relationship between the user and the Developer.",
            footerTerms6Title: "6. Governing Law & Jurisdiction",
            footerTerms6Point1: "These Terms shall be governed by and construed in accordance with the laws of India. Any disputes shall be subject to the exclusive jurisdiction of the courts of Asansol, West Bengal, India."
          },
          hi: {}, bn: {}, mr: {}, ta: {}
        };

        const cessRate = 0.04;

        const defaultProperty = {
            type: 'sop',
            useDetailedGAV: false,
            gav: '0',
            municipalValue: '0',
            fairRent: '0',
            standardRent: '0',
            actualRent: '0',
            municipalTaxes: '0',
            interestOnLoanLOP: '0',
            interestOnLoanSOP: '0',
            loanTypeSOP: 'purchase',
            preConstructionInterest: '0',
        };

        const calculateOldRegimeSlabTaxOnly = (income, ageBand) => {
            let tax = 0;
            let remainingIncome = income;
            const breakdown = [];
            
            const basicExemption = ageBand === 'super' ? 500000 : ageBand === 'senior' ? 300000 : 250000;

            if (remainingIncome > 1000000) {
                const amountInSlab = remainingIncome - 1000000;
                const taxOnSlab = amountInSlab * 0.30;
                tax += taxOnSlab;
                breakdown.unshift({ range: 'Above ₹10,00,000', rate: '30%', tax: taxOnSlab });
                remainingIncome = 1000000;
            }

            if (remainingIncome > 500000) {
                const slabStart = 500000;
                const amountInSlab = remainingIncome - slabStart;
                const taxOnSlab = amountInSlab * 0.20;
                tax += taxOnSlab;
                breakdown.unshift({ range: `₹${(slabStart + 1).toLocaleString('en-IN')} - ₹${(slabStart + amountInSlab).toLocaleString('en-IN')}`, rate: '20%', tax: taxOnSlab });
                remainingIncome = 500000;
            }
            
            if (remainingIncome > basicExemption) {
                const amountInSlab = remainingIncome - basicExemption;
                if (amountInSlab > 0) {
                    const taxOnSlab = amountInSlab * 0.05;
                    tax += taxOnSlab;
                    breakdown.unshift({ range: `₹${(basicExemption + 1).toLocaleString('en-IN')} - ₹${(basicExemption + amountInSlab).toLocaleString('en-IN')}`, rate: '5%', tax: taxOnSlab });
                }
            }

            return { tax, breakdown };
        };

        const calculateOldRegimeTax = (taxableIncome, ageBand, agriculturalIncome = 0) => {
            const agriIncomeNum = Number(agriculturalIncome) || 0;
            const basicExemptionLimit = ageBand === 'below60' ? 250000 : ageBand === 'senior' ? 300000 : 500000;
            const useEffectiveAgriCalc = agriIncomeNum > 5000 && taxableIncome > basicExemptionLimit;

            if (useEffectiveAgriCalc) {
                const incomeForStep1 = taxableIncome + agriIncomeNum;
                const incomeForStep2 = basicExemptionLimit + agriIncomeNum;

                const { tax: taxStep1 } = calculateOldRegimeSlabTaxOnly(incomeForStep1, ageBand);
                const { tax: taxStep2 } = calculateOldRegimeSlabTaxOnly(incomeForStep2, ageBand);

                let taxBeforeRebate = taxStep1 - taxStep2;
                let rebate = 0;

                if (taxableIncome <= 500000) {
                    rebate = Math.min(taxBeforeRebate, 12500);
                }
                
                const finalTax = taxBeforeRebate - rebate;
                const breakdown = [
                    { range: `Tax on Aggregated Income (₹${(incomeForStep1).toLocaleString('en-IN')})`, tax: taxStep1 },
                    { range: `Less: Tax on Slab Base (₹${(incomeForStep2).toLocaleString('en-IN')})`, tax: -taxStep2 },
                ];
                if (rebate > 0) {
                    breakdown.push({ range: 'Rebate u/s 87A', tax: -rebate });
                }
                return { tax: finalTax, breakdown };
            }

            // --- Standard Calculation Logic ---
            let tax = 0;
            const breakdown = [];

            if (taxableIncome <= 500000) {
                if ((ageBand === 'below60' && taxableIncome > 250000) || (ageBand === 'senior' && taxableIncome > 300000)) {
                    let taxBeforeRebate = 0;
                    if (ageBand === 'below60') {
                         taxBeforeRebate = (taxableIncome - 250000) * 0.05;
                         breakdown.push({ range: `₹2,50,001 - ₹${taxableIncome.toLocaleString('en-IN')}`, rate: '5%', tax: taxBeforeRebate });
                    } else { // senior
                         taxBeforeRebate = (taxableIncome - 300000) * 0.05;
                         breakdown.push({ range: `₹3,00,001 - ₹${taxableIncome.toLocaleString('en-IN')}`, rate: '5%', tax: taxBeforeRebate });
                    }
                    breakdown.push({ range: 'Rebate u/s 87A', tax: -taxBeforeRebate });
                }
                return { tax: 0, breakdown };
            }

            let remainingIncome = taxableIncome;
            
            if (remainingIncome > 1000000) {
                const amountInSlab = remainingIncome - 1000000;
                const taxOnSlab = amountInSlab * 0.30;
                tax += taxOnSlab;
                breakdown.unshift({ range: 'Above ₹10,00,000', rate: '30%', tax: taxOnSlab });
                remainingIncome = 1000000;
            }

            if (remainingIncome > 500000) {
                const amountInSlab = remainingIncome - 500000;
                const taxOnSlab = amountInSlab * 0.20;
                tax += taxOnSlab;
                breakdown.unshift({ range: '₹5,00,001 - ₹10,00,000', rate: '20%', tax: taxOnSlab });
                remainingIncome = 500000;
            }

            if (ageBand === 'below60' && remainingIncome > 250000) {
                const taxOnSlab = (remainingIncome - 250000) * 0.05;
                tax += taxOnSlab;
                breakdown.unshift({ range: '₹2,50,001 - ₹5,00,000', rate: '5%', tax: taxOnSlab });
            } else if (ageBand === 'senior' && remainingIncome > 300000) {
                const taxOnSlab = (remainingIncome - 300000) * 0.05;
                tax += taxOnSlab;
                breakdown.unshift({ range: '₹3,00,001 - ₹5,00,000', rate: '5%', tax: taxOnSlab });
            }
            
            return { tax, breakdown };
        };

        const calculateNewRegimeTax = (taxableIncome) => {
            const breakdown = [];
            let tax = 0;

            if (taxableIncome <= 1200000) {
                if (taxableIncome > 400000) {
                    const taxBeforeRebate = (Math.min(taxableIncome, 800000) - 400000) * 0.05
                                       + (Math.max(0, taxableIncome - 800000)) * 0.10;
                    breakdown.push({ range: `On income up to ₹${taxableIncome.toLocaleString('en-IN')}`, tax: taxBeforeRebate });
                    breakdown.push({ range: 'Rebate u/s 87A', tax: -taxBeforeRebate });
                }
                return { tax: 0, breakdown };
            }

            let remainingIncome = taxableIncome;

            if (remainingIncome > 2400000) {
                const taxOnSlab = (remainingIncome - 2400000) * 0.30;
                tax += taxOnSlab;
                breakdown.unshift({ range: 'Above ₹24,00,000', rate: '30%', tax: taxOnSlab });
                remainingIncome = 2400000;
            }
            if (remainingIncome > 2000000) {
                const taxOnSlab = (remainingIncome - 2000000) * 0.25;
                tax += taxOnSlab;
                breakdown.unshift({ range: '₹20,00,001 - ₹24,00,000', rate: '25%', tax: taxOnSlab });
                remainingIncome = 2000000;
            }
            if (remainingIncome > 1600000) {
                const taxOnSlab = (remainingIncome - 1600000) * 0.20;
                tax += taxOnSlab;
                breakdown.unshift({ range: '₹16,00,001 - ₹20,00,000', rate: '20%', tax: taxOnSlab });
                remainingIncome = 1600000;
            }
            if (remainingIncome > 1200000) {
                const taxOnSlab = (remainingIncome - 1200000) * 0.15;
                tax += taxOnSlab;
                breakdown.unshift({ range: '₹12,00,001 - ₹16,00,000', rate: '15%', tax: taxOnSlab });
                remainingIncome = 1200000;
            }
             if (remainingIncome > 800000) {
                const taxOnSlab = (remainingIncome - 800000) * 0.10;
                tax += taxOnSlab;
                breakdown.unshift({ range: '₹8,00,001 - ₹12,00,000', rate: '10%', tax: taxOnSlab });
                remainingIncome = 800000;
            }
            if (remainingIncome > 400000) {
                const taxOnSlab = (remainingIncome - 400000) * 0.05;
                tax += taxOnSlab;
                breakdown.unshift({ range: '₹4,00,001 - ₹8,00,000', rate: '5%', tax: taxOnSlab });
            }

            return { tax, breakdown };
        };


        const calculateSurchargeAndRelief = (
            taxableIncome,
            taxOnIncome,
            regime,
            ageBand
        ) => {
            if (taxableIncome <= 5000000) {
                return { surcharge: 0, rate: 0, marginalRelief: 0 };
            }

            const surchargeSlabs = regime === 'old'
                ? [
                    { threshold: 50000000, rate: 0.37, prevRate: 0.25 },
                    { threshold: 20000000, rate: 0.25, prevRate: 0.15 },
                    { threshold: 10000000, rate: 0.15, prevRate: 0.10 },
                    { threshold: 5000000, rate: 0.10, prevRate: 0.00 },
                ]
                : [
                    { threshold: 20000000, rate: 0.25, prevRate: 0.15 },
                    { threshold: 10000000, rate: 0.15, prevRate: 0.10 },
                    { threshold: 5000000, rate: 0.10, prevRate: 0.00 },
                ];
            
            let rate = 0, threshold = 0, prevRate = 0;
            for (const slab of surchargeSlabs) {
                if (taxableIncome > slab.threshold) {
                    ({ rate, threshold, prevRate } = slab);
                    break;
                }
            }

            const surcharge = taxOnIncome * rate;
            const taxWithSurcharge = taxOnIncome + surcharge;

            let marginalRelief = 0;
            if (threshold > 0) {
                let taxOnThreshold = 0;
                if (regime === 'old') {
                    taxOnThreshold = calculateOldRegimeTax(threshold, ageBand).tax;
                } else {
                    taxOnThreshold = calculateNewRegimeTax(threshold).tax;
                }

                const surchargeOnThreshold = taxOnThreshold * prevRate;
                const taxPayableAtThreshold = taxOnThreshold + surchargeOnThreshold;
                
                const extraIncome = taxableIncome - threshold;
                const extraTax = taxWithSurcharge - taxPayableAtThreshold;

                if (extraTax > extraIncome) {
                    marginalRelief = extraTax - extraIncome;
                }
            }

            return { surcharge, rate, marginalRelief };
        };

        const App = () => {
            const t = useCallback((key, options) => {
                let translation = translations.en[key] || key;
                if (options) {
                    Object.keys(options).forEach(optionKey => {
                        translation = translation.replace(`{${optionKey}}`, String(options[optionKey]));
                    });
                }
                return translation;
            }, []);


            // Income & capital gains
            const [salary, setSalary] = useState('0');
            const [business, setBusiness] = useState('0');
            const [interest, setInterest] = useState('0');
            const [dividend, setDividend] = useState('0');
            const [otherIncome, setOtherIncome] = useState('0');
            const [agriculturalIncome, setAgriculturalIncome] = useState('0');
            const [taxableGifts, setTaxableGifts] = useState('0');
            const [ltcg, setLtcg] = useState('0');
            const [stcg, setStcg] = useState('0');
            const [cryptoGains, setCryptoGains] = useState('0');

            // Salary Breakdown
            const [basicSalary, setBasicSalary] = useState('0');
            const [da, setDa] = useState('0');
            const [hraReceived, setHraReceived] = useState('0');
            const [specialAllowance, setSpecialAllowance] = useState('0');
            const [bonus, setBonus] = useState('0');
            
            // LTA Exemption
            const [ltaReceived, setLtaReceived] = useState('0');
            const [ltaActualExpenses, setLtaActualExpenses] = useState('0');
            const [ltaJourneysClaimed, setLtaJourneysClaimed] = useState("0");
            const [showLtaBreakdown, setShowLtaBreakdown] = useState(false);


            // HRA Exemption
            const [rentPaid, setRentPaid] = useState('0');
            const [isMetro, setIsMetro] = useState(false);
            const [showHraBreakdown, setShowHraBreakdown] = useState(false);
            const [showHousePropertyBreakdown, setShowHousePropertyBreakdown] = useState(false);
            
            // House Property - Advanced
            const [properties, setProperties] = useState([{ ...defaultProperty, id: Date.now() }]);
            const [broughtForwardLossHP, setBroughtForwardLossHP] = useState('0');

            // Deductions
            const [ded80C, setDed80C] = useState('0');
            const [ded80CCD1, setDed80CCD1] = useState('0');
            const [ded80D, setDed80D] = useState('0');
            const [ded80G, setDed80G] = useState('0');
            const [ded80TTA, setDed80TTA] = useState('0');
            const [nps80CCD1B, setNps80CCD1B] = useState('0');
            const [npsEmployer, setNpsEmployer] = useState('0');
            const [professionalTax, setProfessionalTax] = useState('0');
            const [ded80E, setDed80E] = useState('0');
            const [ded80GG, setDed80GG] = useState('0');
            const [ded80U, setDed80U] = useState("none");
            const [ded80DDB, setDed80DDB] = useState('0');
            const [agniveerContribution, setAgniveerContribution] = useState('0');
            const [govtAgniveerContribution, setGovtAgniveerContribution] = useState('0');


            // Taxes already paid (TDS/TCS/Advance Tax)
            const [tds, setTds] = useState('0');
            const [tcs, setTcs] = useState('0');
            const [advanceTax, setAdvanceTax] = useState('0');

            // UX & settings
            const [ageBand, setAgeBand] = useState("below60");
            const [presumptive, setPresumptive] = useState(false);
            const [showOldTaxBreakdown, setShowOldTaxBreakdown] = useState(false);
            const [showNewTaxBreakdown, setShowNewTaxBreakdown] = useState(false);
            const [showTaxSlabs, setShowTaxSlabs] = useState(false);
            const [showSurchargeRates, setShowSurchargeRates] = useState(false);
            const [showAgriTaxHelpModal, setShowAgriTaxHelpModal] = useState(false);
            const [showAgriStep1Breakdown, setShowAgriStep1Breakdown] = useState(false);
            const [showAgriStep2Breakdown, setShowAgriStep2Breakdown] = useState(false);
            const [isCopyrightExpanded, setIsCopyrightExpanded] = useState(false);
            const [isPrivacyExpanded, setIsPrivacyExpanded] = useState(false);
            const [isTermsExpanded, setIsTermsExpanded] = useState(false);
            
            const STD_DEDUCTION_OLD = 50000;
            const STD_DEDUCTION_NEW = 75000;
            const STORAGE_KEY = "taxCalc2025-v2.2"; // Updated key for new state

            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            // Load from localStorage
            useEffect(() => {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    if (!raw) return;
                    const d = JSON.parse(raw);
                    setSalary(String(d.salary || '0'));
                    setBusiness(String(d.business || '0'));
                    setInterest(String(d.interest || '0'));
                    setDividend(String(d.dividend || '0'));
                    setOtherIncome(String(d.otherIncome || '0'));
                    setAgriculturalIncome(String(d.agriculturalIncome || '0'));
                    setTaxableGifts(String(d.taxableGifts || '0'));
                    setLtcg(String(d.ltcg || '0'));
                    setStcg(String(d.stcg || '0'));
                    setCryptoGains(String(d.cryptoGains || '0'));
                    
                    setBasicSalary(String(d.basicSalary || '0'));
                    setDa(String(d.da || '0'));
                    setLtaReceived(String(d.ltaReceived || '0'));
                    setSpecialAllowance(String(d.specialAllowance || '0'));
                    setBonus(String(d.bonus || '0'));
                    setLtaActualExpenses(String(d.ltaActualExpenses || '0'));
                    setLtaJourneysClaimed(d.ltaJourneysClaimed || "0");

                    setHraReceived(String(d.hraReceived || '0'));
                    setRentPaid(String(d.rentPaid || '0'));
                    setIsMetro(typeof d.isMetro === 'boolean' ? d.isMetro : false);

                    if (d.properties && d.properties.length > 0) {
                        setProperties(d.properties);
                    }
                    setBroughtForwardLossHP(String(d.broughtForwardLossHP || '0'));
                    
                    setDed80C(String(d.ded80C || '0'));
                    setDed80CCD1(String(d.ded80CCD1 || '0'));
                    setDed80D(String(d.ded80D || '0'));
                    setDed80G(String(d.ded80G || '0'));
                    setDed80TTA(String(d.ded80TTA || '0'));
                    setNps80CCD1B(String(d.nps80CCD1B || '0'));
                    setNpsEmployer(String(d.npsEmployer || '0'));
                    setProfessionalTax(String(d.professionalTax || '0'));
                    setDed80E(String(d.ded80E || '0'));
                    setDed80GG(String(d.ded80GG || '0'));
                    setDed80U(d.ded80U || "none");
                    setDed80DDB(String(d.ded80DDB || '0'));
                    setAgniveerContribution(String(d.agniveerContribution || '0'));
                    setGovtAgniveerContribution(String(d.govtAgniveerContribution || '0'));
                    setTds(String(d.tds || '0'));
                    setTcs(String(d.tcs || '0'));
                    setAdvanceTax(String(d.advanceTax || '0'));
                    setAgeBand(d.ageBand || "below60");
                    setPresumptive(typeof d.presumptive === 'boolean' ? d.presumptive : false);
                } catch (e) {
                    console.error("Failed to load state from localStorage", e);
                }
            }, []);
            
            // Save to localStorage
            useEffect(() => {
                try {
                    const payload = {
                        salary, business, interest, dividend, otherIncome, agriculturalIncome, taxableGifts, ltcg, stcg, cryptoGains,
                        basicSalary, da, ltaReceived, specialAllowance, bonus, ltaActualExpenses, ltaJourneysClaimed,
                        hraReceived, rentPaid, isMetro,
                        properties, broughtForwardLossHP,
                        ded80C, ded80CCD1, ded80D, ded80G, ded80TTA, nps80CCD1B, npsEmployer, professionalTax, ded80E, ded80GG, ded80U, ded80DDB, agniveerContribution, govtAgniveerContribution,
                        tds, tcs, advanceTax,
                        ageBand, presumptive
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
                } catch (e) {
                    console.error("Failed to save state to localStorage", e);
                }
            }, [
                salary, business, interest, dividend, otherIncome, agriculturalIncome, taxableGifts, ltcg, stcg, cryptoGains,
                basicSalary, da, ltaReceived, specialAllowance, bonus, ltaActualExpenses, ltaJourneysClaimed,
                hraReceived, rentPaid, isMetro,
                properties, broughtForwardLossHP,
                ded80C, ded80CCD1, ded80D, ded80G, ded80TTA, nps80CCD1B, npsEmployer, professionalTax, ded80E, ded80GG, ded80U, ded80DDB, agniveerContribution, govtAgniveerContribution,
                tds, tcs, advanceTax,
                ageBand, presumptive
            ]);

            const handleFocus = (e) => {
                e.target.select();
            };

            const handleNumericStringChange = (setter, max) => (e) => {
                const value = e.target.value;
                if (/^\d*$/.test(value)) { // Only allow digits
                    if (max !== undefined) {
                        const numValue = Number(value);
                        if (numValue <= max) {
                            setter(value);
                        }
                    } else {
                        setter(value);
                    }
                }
            };
            
            const handleBlur = (setter) => (e) => {
                if (e.target.value.trim() === '') {
                    setter('0');
                }
            };

            const handleSalaryChange = (e) => {
                const value = e.target.value;
                if (!/^\d*$/.test(value)) return;

                setSalary(value);
                const newSalary = Number(value || '0');

                if (newSalary > 0) {
                    const newBasic = Math.round(newSalary * 0.50);
                    const newHra = Math.round(newBasic * 0.50);
                    const newLta = Math.round(newBasic * 0.15);
                    const remaining = newSalary - newBasic - newHra - newLta;
                    const newSpecial = Math.max(0, remaining);

                    setBasicSalary(String(newBasic));
                    setDa('0');
                    setHraReceived(String(newHra));
                    setLtaReceived(String(newLta));
                    setSpecialAllowance(String(newSpecial));
                    setBonus('0');
                } else {
                    setBasicSalary('0');
                    setDa('0');
                    setHraReceived('0');
                    setLtaReceived('0');
                    setSpecialAllowance('0');
                    setBonus('0');
                }
            };
            
            const addProperty = () => {
                setProperties([...properties, { ...defaultProperty, id: Date.now() }]);
            };
            const removeProperty = (id) => {
                setProperties(properties.filter(p => p.id !== id));
            };
            const updateProperty = (id, updatedValues) => {
                setProperties(properties.map(p => p.id === id ? { ...p, ...updatedValues } : p));
            };
            
            const handleSOPInterestChange = (id, value) => {
                if (!/^\d*$/.test(value)) return;

                const prop = properties.find(p => p.id === id);
                if (!prop || prop.type !== 'sop') return;

                const cap = prop.loanTypeSOP === 'purchase' ? 200000 : 30000;
                const numValue = Number(value);
                const cappedInterest = Math.min(numValue, cap);

                const preConInterestNum = Number(prop.preConstructionInterest) || 0;
                
                let updatedPreConInterest = preConInterestNum;
                if (cappedInterest + preConInterestNum > cap) {
                    updatedPreConInterest = cap - cappedInterest;
                }
                
                updateProperty(id, { 
                    interestOnLoanSOP: String(cappedInterest),
                    preConstructionInterest: String(updatedPreConInterest)
                });
            };

            const handleSOPPreConInterestChange = (id, value) => {
                if (!/^\d*$/.test(value)) return;
                
                const prop = properties.find(p => p.id === id);
                if (!prop || prop.type !== 'sop') return;

                const cap = prop.loanTypeSOP === 'purchase' ? 200000 : 30000;
                const interestOnLoanNum = Number(prop.interestOnLoanSOP) || 0;
                const remainingAllowance = Math.max(0, cap - interestOnLoanNum);

                const numValue = Number(value);
                const cappedPreConInterest = Math.min(numValue, remainingAllowance);

                updateProperty(id, { preConstructionInterest: String(cappedPreConInterest) });
            };

            const grossIncome = useMemo(() => 
                Number(salary || '0') + 
                Number(business || '0') + 
                Number(interest || '0') + 
                Number(dividend || '0') + 
                Number(otherIncome || '0') +
                (Number(taxableGifts || '0') > 50000 ? Number(taxableGifts || '0') : 0) +
                Number(govtAgniveerContribution || '0'), // Govt contribution is part of income
                [salary, business, interest, dividend, otherIncome, taxableGifts, govtAgniveerContribution]
            );

            const totalSalaryFromComponents = useMemo(() =>
                Number(basicSalary) + Number(da) + Number(hraReceived) + Number(ltaReceived) + Number(specialAllowance) + Number(bonus),
                [basicSalary, da, hraReceived, ltaReceived, specialAllowance, bonus]
            );

            const totalPrepaidTaxes = useMemo(() => Number(tds) + Number(tcs) + Number(advanceTax), [tds, tcs, advanceTax]);

            const maxNpsEmployer = useMemo(() => {
                const salaryBase = Number(basicSalary || '0') + Number(da || '0');
                return Math.round(salaryBase * 0.14);
            }, [basicSalary, da]);
            
            const results = useMemo(() => {
                const ltaReceivedNum = Number(ltaReceived || '0');
                const journeysNum = Number(ltaJourneysClaimed || '0');
                const ltaActualExpensesNum = Number(ltaActualExpenses || '0');

                const ltaExemption = journeysNum > 0 ? Math.min(ltaReceivedNum, ltaActualExpensesNum) : 0;
                
                const hraCalculation = (() => {
                    const hraSalaryBase = Number(basicSalary || '0') + Number(da || '0');
                    const hraReceivedNum = Number(hraReceived || '0');
                    const rentPaidNum = Number(rentPaid || '0');

                    if (hraSalaryBase <= 0 || hraReceivedNum <= 0 || rentPaidNum <= 0) {
                        return { exemption: 0, actualHra: 0, rentOver10pcSalary: 0, salaryPercentageCap: 0, limitedBy: null };
                    }

                    const actualHra = Math.floor(hraReceivedNum);
                    const rentOver10pcSalary = Math.floor(Math.max(0, rentPaidNum - (0.10 * hraSalaryBase)));
                    const salaryPercentageCap = Math.floor(isMetro ? 0.50 * hraSalaryBase : 0.40 * hraSalaryBase);
                    
                    const exemption = Math.min(
                        actualHra,
                        rentOver10pcSalary,
                        salaryPercentageCap
                    );
                    
                    let limitedBy;
                    if (exemption === rentOver10pcSalary) limitedBy = 'rent';
                    else if (exemption === salaryPercentageCap) limitedBy = 'salary';
                    else if (exemption === actualHra) limitedBy = 'actual';

                    return { exemption, actualHra, rentOver10pcSalary, salaryPercentageCap, limitedBy };
                })();
                
                const hraExemption = hraCalculation.exemption;
                const totalExemptionsClaimed = ltaExemption + hraExemption;

                const housePropertyCalculation = (() => {
                    let totalLossFromSOP_Old = 0;
                    let totalIncomeFromLOP_Old = 0;
                    let totalIncomeFromLOP_New = 0; // SOP interest is not allowed in new regime
                    let sopCount = 0;
                    const propertyBreakdowns = [];
                    
                    for (const prop of properties) {
                        if (prop.type === 'sop' && sopCount < 2) {
                            sopCount++;
                            const interest = Number(prop.interestOnLoanSOP) || 0;
                            const preConInterest = prop.loanTypeSOP === 'purchase' ? (Number(prop.preConstructionInterest) || 0) : 0;
                            const totalInterest = interest + preConInterest;
                            const interestCap = prop.loanTypeSOP === 'purchase' ? 200000 : 30000;
                            const loss = -Math.min(totalInterest, interestCap);
                            totalLossFromSOP_Old += loss;
                            propertyBreakdowns.push({
                                id: prop.id, type: 'SOP', isCounted: true, loss, totalInterest, interestCap
                            });
                        } else if (prop.type === 'sop') {
                             propertyBreakdowns.push({
                                id: prop.id, type: 'SOP', isCounted: false, note: t('sopWarning')
                            });
                        } else { // LOP
                            const municipalValue = Number(prop.municipalValue) || 0;
                            const fairRent = Number(prop.fairRent) || 0;
                            const standardRent = Number(prop.standardRent) || 0;
                            const actualRent = Number(prop.actualRent) || 0;
                            
                            let gav = Number(prop.gav) || 0;
                            if (prop.useDetailedGAV) {
                                const expectedRentStep1 = Math.max(municipalValue, fairRent);
                                const expectedRent = standardRent > 0 ? Math.min(expectedRentStep1, standardRent) : expectedRentStep1;
                                gav = Math.max(expectedRent, actualRent);
                            }

                            const municipalTaxes = Number(prop.municipalTaxes) || 0;
                            const nav = gav - municipalTaxes;
                            const standardDeduction = nav > 0 ? nav * 0.3 : 0;
                            const interest = Number(prop.interestOnLoanLOP) || 0;
                            const preConInterest = Number(prop.preConstructionInterest) || 0;
                            const totalInterest = interest + preConInterest;
                            const income = nav - standardDeduction - totalInterest;
                            totalIncomeFromLOP_Old += income;
                            totalIncomeFromLOP_New += income;

                            propertyBreakdowns.push({
                                id: prop.id, type: 'LOP', gav, municipalTaxes, nav, standardDeduction, totalInterest, income
                            });
                        }
                    }

                    // --- Old Regime HP Calculation ---
                    const broughtForwardLossHPNum = Number(broughtForwardLossHP) || 0;
                    const totalHPIncomeBeforeBFLoss_Old = totalIncomeFromLOP_Old + totalLossFromSOP_Old;
                    const broughtForwardLossApplied_Old = Math.min(Math.max(0, totalHPIncomeBeforeBFLoss_Old), broughtForwardLossHPNum);
                    const hpIncomeAfterBFLoss_Old = totalHPIncomeBeforeBFLoss_Old - broughtForwardLossApplied_Old;
                    const totalHousePropertyIncomeUncapped_Old = hpIncomeAfterBFLoss_Old;
                    const hpIncomeOldRegime = totalHousePropertyIncomeUncapped_Old < 0 ? Math.max(totalHousePropertyIncomeUncapped_Old, -200000) : totalHousePropertyIncomeUncapped_Old;

                    // --- New Regime HP Calculation ---
                    // SOP interest loss and B/F loss are not allowed. Loss from LOP cannot be set off.
                    const hpIncomeNewRegime = Math.max(0, totalIncomeFromLOP_New);

                    return {
                        hpIncomeOldRegime,
                        hpIncomeNewRegime,
                        totalHousePropertyIncomeUncapped_Old,
                        isCapped: hpIncomeOldRegime !== totalHousePropertyIncomeUncapped_Old,
                        broughtForwardLossApplied: broughtForwardLossApplied_Old,
                        totalHPIncomeBeforeBFLoss: totalHPIncomeBeforeBFLoss_Old,
                        breakdowns: propertyBreakdowns,
                    };
                })();

                const housePropertyBreakdown = housePropertyCalculation;
                const { hpIncomeOldRegime, hpIncomeNewRegime } = housePropertyBreakdown;

                const taxLtcgVal = (Number(ltcg) || 0) * 0.125;
                const taxStcgVal = (Number(stcg) || 0) * 0.20;
                const capitalGainsTax = taxLtcgVal + taxStcgVal;
                const taxOnCryptoVal = (Number(cryptoGains) || 0) * 0.30;
                const specialRateTaxes = capitalGainsTax + taxOnCryptoVal;

                // --- Old Regime Calculation ---
                const salaryAfterExemptionsOld = Math.max(0, Number(salary) - hraExemption - ltaExemption);
                const grossIncomeBeforeHP_Old = grossIncome - Number(salary) + salaryAfterExemptionsOld;
                const grossTotalIncomeOld = Math.max(0, grossIncomeBeforeHP_Old + hpIncomeOldRegime);

                const isSalaried = Number(salary) > 0;
                const limit80CCD1ByType = isSalaried ? 0.1 * (Number(basicSalary) + Number(da)) : 0.2 * grossTotalIncomeOld;
                const actualDeduction80CCD1 = Math.min(Number(ded80CCD1) || 0, limit80CCD1ByType, 150000);
                const actualDeduction80C = Math.min(Number(ded80C) || 0, 150000 - actualDeduction80CCD1);
                const deductions80CCE = actualDeduction80C + actualDeduction80CCD1;
                
                const maxDed80D = (ageBand === 'senior' || ageBand === 'super') ? 50000 : 25000;
                const cap80D = Math.min(Number(ded80D) || 0, maxDed80D);
                const capNps = Math.min(Number(nps80CCD1B) || 0, 50000);
                const maxDed80TTA = (ageBand === 'senior' || ageBand === 'super') ? 50000 : 10000;
                const cap80TTA = Math.min(Number(ded80TTA) || 0, maxDed80TTA);
                const cap80G = Number(ded80G) || 0;
                const capProfTax = Math.min(Number(professionalTax) || 0, 2500);
                const capNpsEmployer = Math.min(Number(npsEmployer) || 0, maxNpsEmployer);
                const cap80E = Number(ded80E) || 0;
                const cap80GG = Number(hraReceived) > 0 ? 0 : Math.min(Number(ded80GG) || 0, 60000);
                const cap80U = ded80U === 'normal' ? 75000 : ded80U === 'severe' ? 125000 : 0;
                const maxDed80DDB = (ageBand === 'senior' || ageBand === 'super') ? 100000 : 40000;
                const cap80DDB = Math.min(Number(ded80DDB) || 0, maxDed80DDB);
                const capAgniveerContribution = Number(agniveerContribution) || 0;
                const capGovtAgniveerContribution = Number(govtAgniveerContribution) || 0;

                const standardDeductionAppliedOld = Number(salary) > 0 ? STD_DEDUCTION_OLD : 0;
                const professionalTaxApplied = presumptive ? 0 : capProfTax;
                const nps80CCD1BApplied = presumptive ? 0 : capNps;
                const otherChapVIADeductions = presumptive ? 0 : cap80D + cap80TTA + cap80G + cap80E + cap80GG + cap80U + cap80DDB;
                const yourAgniveerDeductionOld = presumptive ? 0 : capAgniveerContribution;
                const govtAgniveerDeductionOld = presumptive ? 0 : capGovtAgniveerContribution;
                
                const totalDeductionsOld = standardDeductionAppliedOld + professionalTaxApplied + nps80CCD1BApplied + otherChapVIADeductions + deductions80CCE + capNpsEmployer + yourAgniveerDeductionOld + govtAgniveerDeductionOld;
                const taxableOld = Math.max(0, grossTotalIncomeOld - totalDeductionsOld);
                
                const { tax: slabTaxOldVal, breakdown: slabTaxOldBreakdown } = calculateOldRegimeTax(taxableOld, ageBand, agriculturalIncome);
                const taxBeforeSurchargeOld = slabTaxOldVal + specialRateTaxes;
                const { surcharge: surchargeOld, rate: surchargeRateOld, marginalRelief: marginalReliefOld } = calculateSurchargeAndRelief(taxableOld + Number(ltcg) + Number(stcg) + Number(cryptoGains), taxBeforeSurchargeOld, 'old', ageBand);
                const taxAfterSurchargeAndReliefOld = taxBeforeSurchargeOld + surchargeOld - marginalReliefOld;
                const cessOld = taxAfterSurchargeAndReliefOld * cessRate;
                const totalTaxOld = taxAfterSurchargeAndReliefOld + cessOld;
                
                const agriIncomeNum = Number(agriculturalIncome) || 0;
                const basicExemptionLimit = ageBand === 'below60' ? 250000 : ageBand === 'senior' ? 300000 : 500000;
                const isAgriCalcApplicable = agriIncomeNum > 5000 && taxableOld > basicExemptionLimit;

                const { tax: slabTaxOldWithoutAgri } = calculateOldRegimeTax(taxableOld, ageBand, 0);
                const agriTaxImpact = isAgriCalcApplicable ? Math.max(0, slabTaxOldVal - slabTaxOldWithoutAgri) : 0;

                // --- New Regime Calculation ---
                const grossIncomeBeforeHP_New = grossIncome;
                const grossTotalIncomeNew = Math.max(0, grossIncomeBeforeHP_New + hpIncomeNewRegime);
                const standardDeductionAppliedNew = Number(salary) > 0 ? STD_DEDUCTION_NEW : 0;
                const govtAgniveerDeductionNew = capGovtAgniveerContribution;
                const totalDeductionsNew = standardDeductionAppliedNew + capNpsEmployer + govtAgniveerDeductionNew;
                const taxableNew = Math.max(0, grossTotalIncomeNew - totalDeductionsNew);
                
                const { tax: slabTaxNewVal, breakdown: slabTaxNewBreakdown } = calculateNewRegimeTax(taxableNew);
                const taxBeforeSurchargeNew = slabTaxNewVal + specialRateTaxes;
                const { surcharge: surchargeNew, rate: surchargeRateNew, marginalRelief: marginalReliefNew } = calculateSurchargeAndRelief(taxableNew + Number(ltcg) + Number(stcg) + Number(cryptoGains), taxBeforeSurchargeNew, 'new', ageBand);
                const taxAfterSurchargeAndReliefNew = taxBeforeSurchargeNew + surchargeNew - marginalReliefNew;
                const cessNew = taxAfterSurchargeAndReliefNew * cessRate;
                const totalTaxNew = taxAfterSurchargeAndReliefNew + cessNew;

                const netOld = totalTaxOld - totalPrepaidTaxes;
                const netNew = totalTaxNew - totalPrepaidTaxes;
                
                const potential80CCE = Math.max(0, 150000 - deductions80CCE);
                const potentialNPS = Math.max(0, 50000 - capNps);
                const potential80D = Math.max(0, maxDed80D - cap80D);
                const potentialProfTax = Math.max(0, 2500 - capProfTax);
                const potential80TTA = Math.max(0, maxDed80TTA - cap80TTA);
                
                const potential80GG = (Number(hraReceived) > 0 || presumptive) ? 0 : Math.max(0, 60000 - cap80GG);
                const potential80DDB = presumptive ? 0 : Math.max(0, maxDed80DDB - cap80DDB);

                const totalPotentialDeductions = presumptive ? 0 : (potential80CCE + potentialNPS + potential80D + potentialProfTax + potential80TTA + potential80GG + potential80DDB);
                const potentialTaxableOld = Math.max(0, taxableOld - totalPotentialDeductions);

                const { tax: potentialSlabTaxOldVal } = calculateOldRegimeTax(potentialTaxableOld, ageBand, agriculturalIncome);
                const potentialTaxBeforeSurchargeOld = potentialSlabTaxOldVal + specialRateTaxes;
                const { surcharge: potSurcharge, marginalRelief: potRelief } = calculateSurchargeAndRelief(potentialTaxableOld, potentialTaxBeforeSurchargeOld, 'old', ageBand);
                const potentialTaxAfterSurcharge = potentialTaxBeforeSurchargeOld + potSurcharge - potRelief;
                const potentialCessOld = potentialTaxAfterSurcharge * cessRate;
                const potentialTotalTaxOld = potentialTaxAfterSurcharge + potentialCessOld;
                const potentialTaxSaving = Math.max(0, totalTaxOld - potentialTotalTaxOld);
                const potentialNetPayableOld = potentialTotalTaxOld - totalPrepaidTaxes;

                let itrSuggestion = "ITR-1 (Sahaj)";
                let itrSuggestionReason = "For individuals with salary, one house property, and other income sources up to ₹50 lakh.";
                if (presumptive) {
                    itrSuggestion = "ITR-4 (Sugam)";
                    itrSuggestionReason = "For individuals who have opted for the presumptive taxation scheme under Sec 44AD, 44ADA, or 44AE.";
                } else if (Number(business) > 0) {
                    itrSuggestion = "ITR-3";
                    itrSuggestionReason = "For individuals having income from a business or profession.";
                } else if (Number(agriculturalIncome) > 5000) {
                    itrSuggestion = "ITR-2";
                    itrSuggestionReason = t('itrFormReasonAgri');
                } else if (Number(ltcg) > 0 || Number(stcg) > 0 || Number(cryptoGains) > 0 || properties.length > 1 || hpIncomeOldRegime !== 0) {
                    itrSuggestion = "ITR-2";
                    itrSuggestionReason = "Required for reporting Capital Gains, Crypto/VDA, or Income/Loss from House Property.";
                } else if (grossIncome > 5000000) {
                    itrSuggestion = "ITR-2";
                    itrSuggestionReason = "Required when total income exceeds ₹50 lakh.";
                }

                let suggestionResult = "Tie";
                if (totalTaxOld < totalTaxNew) {
                    suggestionResult = "Old Regime";
                } else if (totalTaxNew < totalTaxOld) {
                    suggestionResult = "New Regime";
                }

                return {
                    ltaExemption, ltaReceivedNum, ltaActualExpensesNum,
                    hraExemption, totalExemptionsClaimed,
                    hraCalculation,
                    hpIncomeOldRegime,
                    hpIncomeNewRegime,
                    housePropertyBreakdown,
                    grossIncomeBeforeHP_Old,
                    grossTotalIncomeOld,
                    grossIncomeBeforeHP_New,
                    grossTotalIncomeNew,
                    
                    taxableOld, totalTaxOld, netOld, slabTaxOldVal, slabTaxOldBreakdown, 
                    surchargeOld, surchargeRateOld, marginalReliefOld,
                    taxAfterSurchargeAndReliefOld, cessOld, standardDeductionAppliedOld, professionalTaxApplied, 
                    actualDeduction80C, actualDeduction80CCD1, otherChapVIADeductions,
                    nps80CCD1BApplied,
                    totalDeductionsOld,
                    
                    taxableNew, totalTaxNew, netNew, slabTaxNewVal, slabTaxNewBreakdown,
                    surchargeNew, surchargeRateNew, marginalReliefNew,
                    taxAfterSurchargeAndReliefNew, cessNew, standardDeductionAppliedNew, npsEmployerApplied: capNpsEmployer,
                    totalDeductionsNew,
                    
                    capitalGainsTax, taxOnCryptoVal, taxLtcgVal, taxStcgVal, itrSuggestion, itrSuggestionReason,
                    
                    yourAgniveerContributionApplied: yourAgniveerDeductionOld,
                    govtAgniveerContributionApplied: govtAgniveerDeductionOld,
                    govtAgniveerContributionAppliedNew: govtAgniveerDeductionNew,
                    
                    isAgriCalcApplicable,
                    agriTaxImpact,

                    isSalaried,
                    suggestion: suggestionResult,
                    taxSavingOpportunities: {
                        potential80CCE, potentialNPS, potential80D, potentialProfTax, potential80TTA,
                        potential80GG, potential80DDB,
                        potentialTotalTaxOld, potentialTaxSaving, potentialNetPayableOld,
                    },
                };
            }, [grossIncome, ltcg, stcg, cryptoGains, basicSalary, da, hraReceived, rentPaid, isMetro, ltaReceived, ltaActualExpenses, ltaJourneysClaimed, ded80C, ded80CCD1, ded80D, ded80G, ded80TTA, nps80CCD1B, npsEmployer, professionalTax, ded80E, ded80GG, ded80U, ded80DDB, agniveerContribution, govtAgniveerContribution, salary, ageBand, totalPrepaidTaxes, presumptive, properties, broughtForwardLossHP, taxableGifts, agriculturalIncome, t, maxNpsEmployer]);

            const money = (v) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(v || 0);
            const moneyAbs = (v) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(Math.abs(v) || 0);

            const savings = Math.abs(results.totalTaxOld - results.totalTaxNew);

            const totalReductionsOld = results.totalExemptionsClaimed + results.totalDeductionsOld + Math.max(0, -results.hpIncomeOldRegime);
            const totalReductionsNew = results.totalDeductionsNew;

            const monthsOfTaxOld = grossIncome > 0 ? (results.totalTaxOld / grossIncome) * 12 : 0;
            const monthsOfTaxNew = grossIncome > 0 ? (results.totalTaxNew / grossIncome) * 12 : 0;

            const monthsOfDeductionsOld = grossIncome > 0 ? (totalReductionsOld / grossIncome) * 12 : 0;
            const monthsOfDeductionsNew = grossIncome > 0 ? (totalReductionsNew / grossIncome) * 12 : 0;

            const monthsTakeHomeOld = Math.max(0, 12 - monthsOfTaxOld - monthsOfDeductionsOld);
            const monthsTakeHomeNew = Math.max(0, 12 - monthsOfTaxNew - monthsOfDeductionsNew);


            useEffect(() => {
                const ctx = canvasRef.current?.getContext("2d");
                if (!ctx) return;

                // --- Data Calculation for Chart ---
                const grossIncomeForChart = grossIncome > 0 ? grossIncome : 0;
                
                // Old Regime Data
                const taxOld = results.totalTaxOld > 0 ? results.totalTaxOld : 0;
                const postTaxationIncomeOld = Math.max(0, grossIncomeForChart - totalReductionsOld - taxOld);
                const totalOld = taxOld + totalReductionsOld + postTaxationIncomeOld;
                
                // New Regime Data
                const taxNew = results.totalTaxNew > 0 ? results.totalTaxNew : 0;
                const postTaxationIncomeNew = Math.max(0, grossIncomeForChart - totalReductionsNew - taxNew);
                const totalNew = taxNew + totalReductionsNew + postTaxationIncomeNew;
                
                // Percentage calculations
                const taxOldPercent = totalOld > 0 ? (taxOld / totalOld) * 100 : 0;
                const reductionsOldPercent = totalOld > 0 ? (totalReductionsOld / totalOld) * 100 : 0;
                const postTaxOldPercent = totalOld > 0 ? (postTaxationIncomeOld / totalOld) * 100 : 0;
                
                const taxNewPercent = totalNew > 0 ? (taxNew / totalNew) * 100 : 0;
                const reductionsNewPercent = totalNew > 0 ? (totalReductionsNew / totalNew) * 100 : 0;
                const postTaxNewPercent = totalNew > 0 ? (postTaxationIncomeNew / totalNew) * 100 : 0;

                const data = {
                    labels: [t('oldRegimeTitle'), t('newRegimeTitle')],
                    datasets: [
                        {
                            label: t('chartLabelTax'),
                            data: [taxOldPercent, taxNewPercent],
                            rawValue: [taxOld, taxNew],
                            backgroundColor: 'rgba(239, 68, 68, 0.7)', // red-500
                        },
                        {
                            label: t('chartLabelReductions'),
                            data: [reductionsOldPercent, reductionsNewPercent],
                            rawValue: [totalReductionsOld, totalReductionsNew],
                            backgroundColor: 'rgba(251, 191, 36, 0.7)', // amber-400
                        },
                        {
                            label: t('chartLabelPostTax'),
                            data: [postTaxOldPercent, postTaxNewPercent],
                            rawValue: [postTaxationIncomeOld, postTaxationIncomeNew],
                            backgroundColor: 'rgba(34, 197, 94, 0.7)', // green-500
                        }
                    ]
                };

                // Custom plugin to draw percentage labels on the bars
                const customDatalabels = {
                    id: 'customDatalabels',
                    afterDatasetsDraw(chart) {
                        const { ctx } = chart;
                        ctx.save();
                        ctx.font = 'bold 12px sans-serif';
                        ctx.fillStyle = 'white';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';

                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            if (!meta.hidden) {
                                meta.data.forEach((element, index) => {
                                    const value = dataset.data[index];
                                    if (value > 5) { // Only show label if segment is > 5%
                                        const label = value.toFixed(1) + '%';
                                        const { x, y, base } = element;
                                        const position = base + (x - base) / 2;
                                        ctx.fillText(label, position, y);
                                    }
                                });
                            }
                        });
                        ctx.restore();
                    }
                };

                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                chartRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    plugins: [customDatalabels],
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const dataset = context.chart.data.datasets[context.datasetIndex];
                                        const rawVal = dataset.rawValue?.[context.dataIndex] ?? 0;
                                        const percentVal = (dataset.data[context.dataIndex]);
                                        return `${dataset.label}: ${money(rawVal)} (${(percentVal).toFixed(2)}%)`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                max: 100,
                                ticks: {
                                    callback: value => value + '%'
                                }
                            },
                            y: {
                                stacked: true,
                            }
                        }
                    }
                });

                return () => {
                    chartRef.current?.destroy();
                };
            }, [results.totalTaxOld, results.totalTaxNew, grossIncome, t, totalReductionsOld, totalReductionsNew]);

            
            const inputClass = "w-full p-2 border rounded bg-gray-100 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed";
            const cardClass = "bg-white rounded-lg shadow-md p-6";

            const max80D = ageBand === 'below60' ? 25000 : 50000;
            const max80TTA = (ageBand === 'senior' || ageBand === 'super') ? 50000 : 10000;
            const max80DDB = (ageBand === 'senior' || ageBand === 'super') ? 100000 : 40000;

            const handle80GGCheckboxChange = (e) => {
                if (e.target.checked) {
                    setDed80GG('60000');
                } else {
                    setDed80GG('0');
                }
            };

            const handle80DDBCheckboxChange = (e) => {
                if (e.target.checked) {
                    setDed80DDB(String(max80DDB));
                } else {
                    setDed80DDB('0');
                }
            };
            
            const infoTooltip = (title) => (
                <span className="ml-2 h-4 w-4 flex-shrink-0 inline-flex items-center justify-center bg-gray-400 text-white rounded-full text-xs font-bold cursor-help" title={title}>
                    i
                </span>
            );
            
            const sopCount = useMemo(() => properties.filter(p => p.type === 'sop').length, [properties]);

            const ded80CNum = Number(ded80C) || 0;
            const ded80CCD1Num = Number(ded80CCD1) || 0;
            const remaining80C_limit = 150000 - ded80CCD1Num;
            const remaining80CCD1_limit = 150000 - ded80CNum;

            const AgriTaxModal = () => {
                const agriIncomeNum = Number(agriculturalIncome) || 0;
                const basicExemptionLimit = ageBand === 'below60' ? 250000 : ageBand === 'senior' ? 300000 : 500000;

                if (!showAgriTaxHelpModal || !results.isAgriCalcApplicable) return null;

                const incomeForStep1 = results.taxableOld + agriIncomeNum;
                const incomeForStep2 = basicExemptionLimit + agriIncomeNum;
                const { tax: taxStep1, breakdown: breakdownStep1 } = calculateOldRegimeSlabTaxOnly(incomeForStep1, ageBand);
                const { tax: taxStep2, breakdown: breakdownStep2 } = calculateOldRegimeSlabTaxOnly(incomeForStep2, ageBand);

                const handleCloseAgriModal = () => {
                    setShowAgriTaxHelpModal(false);
                    setShowAgriStep1Breakdown(false);
                    setShowAgriStep2Breakdown(false);
                };

                return (
                    <div 
                        className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4"
                        onClick={handleCloseAgriModal}
                        role="dialog"
                        aria-modal="true"
                        aria-labelledby="agri-modal-title"
                    >
                        <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl" onClick={e => e.stopPropagation()}>
                            <h2 id="agri-modal-title" className="text-xl font-bold text-gray-800 mb-4">{t('agriTaxModalTitle')}</h2>
                            <p className="text-sm text-gray-600 mb-4">{t('agriTaxModalIntro')}</p>
                            
                            <div className="space-y-4 text-sm">
                                <div className="p-4 bg-blue-50 rounded-lg">
                                    <h3 className="font-semibold text-blue-800 mb-2">{t('agriTaxModalStep1')}</h3>
                                    <div className="flex justify-between"><span>{t('agriTaxModalNormalIncome')}</span><span>{money(results.taxableOld)}</span></div>
                                    <div className="flex justify-between"><span>{t('agriTaxModalAgriIncome')}</span><span>+ {money(agriIncomeNum)}</span></div>
                                    <hr className="my-1"/>
                                    <div className="flex justify-between font-bold"><span>{t('agriTaxModalCombinedIncome')}</span><span>{money(incomeForStep1)}</span></div>
                                    <div className="flex justify-between items-center mt-2 font-semibold text-blue-700">
                                        <span>
                                            {t('agriTaxModalTaxOnCombined')}
                                            <button 
                                                onClick={() => setShowAgriStep1Breakdown(!showAgriStep1Breakdown)}
                                                className="ml-2 text-xs font-normal text-blue-600 hover:underline focus:outline-none"
                                                aria-expanded={showAgriStep1Breakdown}
                                            >
                                                ({showAgriStep1Breakdown ? t('hideCalculation') : t('showCalculation')})
                                            </button>
                                        </span>
                                        <span>{money(taxStep1)}</span>
                                    </div>
                                    {showAgriStep1Breakdown && (
                                        <div className="mt-2 p-2 bg-blue-100 border border-blue-200 rounded-md text-xs space-y-1">
                                            <div className="flex justify-between">
                                                <span>Tax up to {money(basicExemptionLimit)}</span>
                                                <span>{t('slabNil')}</span>
                                            </div>
                                            {breakdownStep1.map((slab, index) => (
                                                <div key={index} className="flex justify-between">
                                                    <span>{slab.range} @ {slab.rate}</span>
                                                    <span>{money(slab.tax)}</span>
                                                </div>
                                            ))}
                                            <div className="flex justify-between font-bold border-t border-blue-300 pt-1 mt-1">
                                                <span>{t('totalSlabTax')}</span>
                                                <span>{money(taxStep1)}</span>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="p-4 bg-yellow-50 rounded-lg">
                                    <h3 className="font-semibold text-yellow-800 mb-2">{t('agriTaxModalStep2')}</h3>
                                    <div className="flex justify-between"><span>{t('agriTaxModalBasicExemption')}</span><span>{money(basicExemptionLimit)}</span></div>
                                    <div className="flex justify-between"><span>{t('agriTaxModalAgriIncome')}</span><span>+ {money(agriIncomeNum)}</span></div>
                                    <hr className="my-1"/>
                                    <div className="flex justify-between font-bold"><span>{t('agriTaxModalBaseForStep2')}</span><span>{money(incomeForStep2)}</span></div>
                                     <div className="flex justify-between items-center mt-2 font-semibold text-yellow-700">
                                        <span>
                                            {t('agriTaxModalTaxOnBase')}
                                            <button 
                                                onClick={() => setShowAgriStep2Breakdown(!showAgriStep2Breakdown)}
                                                className="ml-2 text-xs font-normal text-yellow-800 hover:underline focus:outline-none"
                                                aria-expanded={showAgriStep2Breakdown}
                                            >
                                                ({showAgriStep2Breakdown ? t('hideCalculation') : t('showCalculation')})
                                            </button>
                                        </span>
                                        <span className="text-yellow-800">{money(taxStep2)}</span>
                                    </div>
                                    <p className="text-xs text-gray-600 mt-1">{t('agriTaxModalRebateExplanation')}</p>
                                    {showAgriStep2Breakdown && (
                                        <div className="mt-2 p-2 bg-yellow-100 border border-yellow-200 rounded-md text-xs space-y-1">
                                            <div className="flex justify-between">
                                                <span>Tax up to {money(basicExemptionLimit)}</span>
                                                <span>{t('slabNil')}</span>
                                            </div>
                                            {breakdownStep2.map((slab, index) => (
                                                <div key={index} className="flex justify-between">
                                                    <span>{slab.range} @ {slab.rate}</span>
                                                    <span>{money(slab.tax)}</span>
                                                </div>
                                            ))}
                                            <div className="flex justify-between font-bold border-t border-yellow-300 pt-1 mt-1">
                                                <span>{t('totalSlabTax')}</span>
                                                <span>{money(taxStep2)}</span>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="p-4 bg-green-50 rounded-lg">
                                    <h3 className="font-semibold text-green-800 mb-2">{t('agriTaxModalStep3')}</h3>
                                    <div className="flex flex-col items-end font-bold text-xl text-green-700">
                                        <span className="text-sm font-normal text-gray-700">{money(taxStep1)} - {money(taxStep2)}</span>
                                        <div>
                                          <span>{t('agriTaxModalFinalResult')}: </span>
                                          <span>{money(results.slabTaxOldVal)}</span>
                                        </div>
                                    </div>
                                    <p className="text-xs text-gray-600 mt-2">{t('agriTaxModalFinalTax')}</p>
                                </div>
                            </div>

                            <div className="mt-6 text-right">
                                <button
                                    onClick={handleCloseAgriModal}
                                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                                >
                                    {t('closeButton')}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
              <div className="min-h-screen bg-gray-100 text-gray-900 transition-colors duration-300">
                <AgriTaxModal />
                <div className="container mx-auto p-4 sm:p-6 lg:p-8">
                    <header className="text-center mb-6 relative">
                        <h1 className="text-2xl sm:text-4xl font-bold text-gray-800">{t('appTitle')}</h1>
                        <p className="text-sm italic text-gray-600 mt-1">{t('appSubtitle')}</p>
                    </header>
                    
                    <div className={`${cardClass} mb-6`}>
                        <h3 className="text-xl font-semibold mb-4 border-b pb-2">{t('assesseeProfile')}</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                            <div>
                                <label className="block text-sm font-medium mb-1">{t('yourAgeGroup')}</label>
                                <select value={ageBand} onChange={e => setAgeBand(e.target.value)} className={inputClass}>
                                    <option value="below60">{t('ageBelow60')}</option>
                                    <option value="senior">{t('ageSenior')}</option>
                                    <option value="super">{t('ageSuperSenior')}</option>
                                </select>
                                <p className="text-xs text-gray-500 mt-1">{t('ageHint')}</p>
                            </div>
                            <div className="flex items-start pt-1">
                                <input type="checkbox" id="presumptive" checked={presumptive} onChange={e => setPresumptive(e.target.checked)} className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mt-1"/>
                                <div className="ml-3">
                                    <label htmlFor="presumptive" className="block text-sm font-medium">{t('usePresumptive')}</label>
                                    <p className="text-xs text-gray-500 mt-1">
                                       {t('presumptiveHint')}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <main className="grid lg:grid-cols-5 gap-6">
                        <div className="lg:col-span-3 flex flex-col gap-6">
                            <div className={cardClass}>
                                <h3 className="text-xl font-semibold mb-4 border-b pb-2">{t('incomeAndGains')}</h3>
                                <div className="grid sm:grid-cols-2 gap-4">
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">{t('salaryLabel')}</label>
                                            <input type="text" inputMode="numeric" pattern="\d*" value={salary} onChange={handleSalaryChange} onBlur={handleBlur(setSalary)} onFocus={handleFocus} className={inputClass} />
                                        </div>
                                        <div><label className="block text-sm font-medium mb-1">{t('interestIncomeLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={interest} onChange={handleNumericStringChange(setInterest)} onBlur={handleBlur(setInterest)} onFocus={handleFocus} className={inputClass} /></div>
                                        <div><label className="block text-sm font-medium mb-1">{t('dividendIncomeLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={dividend} onChange={handleNumericStringChange(setDividend)} onBlur={handleBlur(setDividend)} onFocus={handleFocus} className={inputClass} /></div>
                                        <div>
                                            <label className="flex items-center text-sm font-medium mb-1">
                                                {t('otherIncomeLabel')}
                                                {infoTooltip(t('otherIncomeTooltip'))}
                                            </label>
                                            <input type="text" inputMode="numeric" pattern="\d*" value={otherIncome} onChange={handleNumericStringChange(setOtherIncome)} onBlur={handleBlur(setOtherIncome)} onFocus={handleFocus} className={inputClass} />
                                        </div>
                                        <div>
                                            <label className="flex items-center text-sm font-medium mb-1">
                                                {t('agriculturalIncomeLabel')}
                                                {infoTooltip(t('agriculturalIncomeTooltip'))}
                                            </label>
                                            <input type="text" inputMode="numeric" pattern="\d*" value={agriculturalIncome} onChange={handleNumericStringChange(setAgriculturalIncome)} onBlur={handleBlur(setAgriculturalIncome)} onFocus={handleFocus} className={inputClass} />
                                            <p className="text-xs text-gray-500 mt-1">{t('agriculturalIncomeNote')}</p>
                                            {results.isAgriCalcApplicable && (
                                                <div className="mt-2 space-y-1">
                                                     <button 
                                                        onClick={() => setShowAgriTaxHelpModal(true)}
                                                        className="text-xs text-blue-600 hover:underline font-semibold"
                                                    >
                                                       {t('howAgriIsCalculated')}
                                                    </button>
                                                    {results.agriTaxImpact > 0 && (
                                                        <div className="text-xs p-2 rounded-lg bg-yellow-50 border border-yellow-200 text-yellow-800">
                                                            <span className="font-semibold">{t('agriTaxImpactLabel')} </span>
                                                            <span className="font-bold">{money(results.agriTaxImpact)}</span>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        <div><label className="block text-sm font-medium mb-1">{t('businessProfessionLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={business} onChange={handleNumericStringChange(setBusiness)} onBlur={handleBlur(setBusiness)} onFocus={handleFocus} className={inputClass} /></div>
                                        <div>
                                            <label className="flex items-center text-sm font-medium mb-1">
                                                {t('ltcgLabel')}
                                                {infoTooltip(t('ltcgTooltip'))}
                                            </label>
                                            <input type="text" inputMode="numeric" pattern="\d*" value={ltcg} onChange={handleNumericStringChange(setLtcg)} onBlur={handleBlur(setLtcg)} onFocus={handleFocus} className={inputClass} />
                                        </div>
                                        <div>
                                            <label className="flex items-center text-sm font-medium mb-1">
                                                {t('stcgLabel')}
                                                {infoTooltip(t('stcgTooltip'))}
                                            </label>
                                            <input type="text" inputMode="numeric" pattern="\d*" value={stcg} onChange={handleNumericStringChange(setStcg)} onBlur={handleBlur(setStcg)} onFocus={handleFocus} className={inputClass} />
                                        </div>
                                        <div><label className="block text-sm font-medium mb-1">{t('cryptoGainsLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={cryptoGains} onChange={handleNumericStringChange(setCryptoGains)} onBlur={handleBlur(setCryptoGains)} onFocus={handleFocus} className={inputClass} /></div>
                                        <div>
                                            <label className="flex items-center text-sm font-medium mb-1">
                                                {t('taxableGiftsLabel')}
                                                {infoTooltip(t('taxableGiftsTooltip'))}
                                            </label>
                                            <input type="text" inputMode="numeric" pattern="\d*" value={taxableGifts} onChange={handleNumericStringChange(setTaxableGifts)} onBlur={handleBlur(setTaxableGifts)} onFocus={handleFocus} className={inputClass} />
                                            <p className="text-xs text-gray-500 mt-1">{t('taxableGiftsNote')}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className={`${cardClass} ${presumptive ? 'opacity-50' : ''}`}>
                                <h3 className="text-xl font-semibold mb-4 border-b pb-2">{t('salaryDetailsTitle')}</h3>
                                <p className="text-xs text-gray-500 -mt-2 mb-4">
                                   {t('salaryDetailsHint')}
                                </p>
                                <div className="grid sm:grid-cols-2 gap-4">
                                    <h4 className="sm:col-span-2 text-md font-semibold text-gray-700 -mb-2">{t('salaryBreakdown')}</h4>
                                    <div><label className="block text-sm font-medium mb-1">{t('basicSalaryLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={basicSalary} onChange={handleNumericStringChange(setBasicSalary)} onBlur={handleBlur(setBasicSalary)} onFocus={handleFocus} className={inputClass} disabled={presumptive} /></div>
                                    <div><label className="block text-sm font-medium mb-1">{t('daLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={da} onChange={handleNumericStringChange(setDa)} onBlur={handleBlur(setDa)} onFocus={handleFocus} className={inputClass} disabled={presumptive} /></div>
                                    <div><label className="block text-sm font-medium mb-1">{t('hraReceivedLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={hraReceived} onChange={handleNumericStringChange(setHraReceived)} onBlur={handleBlur(setHraReceived)} onFocus={handleFocus} className={inputClass} disabled={presumptive} /></div>
                                    <div><label className="block text-sm font-medium mb-1">{t('ltaLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={ltaReceived} onChange={handleNumericStringChange(setLtaReceived)} onBlur={handleBlur(setLtaReceived)} onFocus={handleFocus} className={inputClass} disabled={presumptive} /></div>
                                    <div><label className="block text-sm font-medium mb-1">{t('specialAllowanceLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={specialAllowance} onChange={handleNumericStringChange(setSpecialAllowance)} onBlur={handleBlur(setSpecialAllowance)} onFocus={handleFocus} className={inputClass} disabled={presumptive} /></div>
                                    <div><label className="block text-sm font-medium mb-1">{t('bonusLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={bonus} onChange={handleNumericStringChange(setBonus)} onBlur={handleBlur(setBonus)} onFocus={handleFocus} className={inputClass} disabled={presumptive} /></div>
                                     <div className="sm:col-span-2 text-sm font-semibold p-2 rounded bg-gray-100 text-center">
                                        {t('calculatedTotal')} {money(totalSalaryFromComponents)}
                                        {Math.round(totalSalaryFromComponents) !== Number(salary) && Number(salary) > 0 && <span className="ml-2 text-red-600">{t('mismatchWarning')}</span>}
                                    </div>
                                    
                                    <hr className="sm:col-span-2 my-2" />
                                    <h4 className="sm:col-span-2 text-md font-semibold text-gray-700 -mb-2">{t('hraExemptionPlanner')}</h4>
                                    <div><label className="block text-sm font-medium mb-1">{t('rentPaidLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={rentPaid} onChange={handleNumericStringChange(setRentPaid)} onBlur={handleBlur(setRentPaid)} onFocus={handleFocus} className={inputClass} disabled={presumptive} /></div>
                                     <div className="flex items-center">
                                        <input type="checkbox" id="isMetro" checked={isMetro} onChange={e => setIsMetro(e.target.checked)} className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" disabled={presumptive} />
                                        <label htmlFor="isMetro" className="ml-2 block text-sm">{t('metroCityLabel')}</label>
                                    </div>
                                    {results.hraExemption > 0 && (
                                        <div className="text-sm sm:col-span-2">
                                            <p className="font-semibold text-green-700">
                                                {t('calculatedHraExemption')} {money(results.hraExemption)}
                                                <button 
                                                    onClick={() => setShowHraBreakdown(!showHraBreakdown)}
                                                    className="ml-2 text-xs text-blue-600 hover:underline focus:outline-none"
                                                    aria-expanded={showHraBreakdown}
                                                >
                                                    ({showHraBreakdown ? t('hideCalculation') : t('showCalculation')})
                                                </button>
                                            </p>
                                            {showHraBreakdown && (
                                                <div className="mt-2 p-3 bg-gray-50 rounded-lg border text-xs text-gray-700 space-y-1">
                                                    <p className="font-semibold">{t('hraLowestOf')}</p>
                                                    <div className={`flex justify-between ${results.hraCalculation.limitedBy === 'actual' ? 'font-bold text-blue-700' : ''}`}>
                                                        <span>{t('actualHraReceived')}</span>
                                                        <span>{money(results.hraCalculation.actualHra)}</span>
                                                    </div>
                                                    <div className={`flex justify-between ${results.hraCalculation.limitedBy === 'rent' ? 'font-bold text-blue-700' : ''}`}>
                                                        <span>{t('rentOver10pcSalary')}</span>
                                                        <span>{money(results.hraCalculation.rentOver10pcSalary)}</span>
                                                    </div>
                                                    <div className={`flex justify-between ${results.hraCalculation.limitedBy === 'salary' ? 'font-bold text-blue-700' : ''}`}>
                                                        <span>{t('salaryPercentageCap', {percentage: isMetro ? 50 : 40, cityType: isMetro ? t('metro') : t('non-metro')})}</span>
                                                        <span>{money(results.hraCalculation.salaryPercentageCap)}</span>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    
                                    <hr className="sm:col-span-2 my-2" />
                                    <h4 className="sm:col-span-2 text-md font-semibold text-gray-700 -mb-2">{t('otherSalaryDeductions')}</h4>
                                    <div><label className="block text-sm font-medium mb-1">{t('professionalTaxLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={professionalTax} onChange={handleNumericStringChange(setProfessionalTax, 2500)} onBlur={handleBlur(setProfessionalTax)} onFocus={handleFocus} className={inputClass} disabled={presumptive}/></div>
                                </div>
                            </div>
                            
                            <div className={cardClass}>
                                <h3 className="text-xl font-semibold mb-4 border-b pb-2">{t('npsContributionsTitle')}</h3>
                                <div className="grid sm:grid-cols-2 gap-4">
                                    <div>
                                        <label className="flex items-center text-sm font-medium mb-1">
                                          {t('npsIndividualContributionLabel')}
                                          {infoTooltip(t('npsIndividualContributionTooltip'))}
                                        </label>
                                        <p className="text-xs text-gray-500 mb-1">{t('npsIndividualContributionHint')}</p>
                                        <input type="text" inputMode="numeric" pattern="\d*" value={ded80CCD1} onChange={handleNumericStringChange(setDed80CCD1, remaining80CCD1_limit)} onBlur={handleBlur(setDed80CCD1)} onFocus={handleFocus} className={inputClass} disabled={presumptive}/>
                                        {(ded80CNum > 0 || ded80CCD1Num > 0) && (
                                          <p className="text-xs text-blue-600 mt-1" dangerouslySetInnerHTML={{ __html: t('sharedLimitNote', { claimedVal: money(ded80CNum), claimedSec: '80C', otherSec: '80CCD(1)', limitVal: money(remaining80CCD1_limit) }) }} />
                                        )}
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">{t('npsVoluntaryLabel')}</label>
                                        <p className="text-xs text-gray-500 mb-1">{t('npsVoluntaryHint')}</p>
                                        <input type="text" inputMode="numeric" pattern="\d*" value={nps80CCD1B} onChange={handleNumericStringChange(setNps80CCD1B, 50000)} onBlur={handleBlur(setNps80CCD1B)} onFocus={handleFocus} className={inputClass} disabled={presumptive}/>
                                    </div>
                                    <div className="sm:col-span-2">
                                        <label className="block text-sm font-medium mb-1">{t('npsEmployerLabel')}</label>
                                        <p className="text-xs text-gray-500 mb-1">{t('npsEmployerHint')}</p>
                                        <input type="text" inputMode="numeric" pattern="\d*" value={npsEmployer} onChange={handleNumericStringChange(setNpsEmployer, maxNpsEmployer)} onBlur={handleBlur(setNpsEmployer)} onFocus={handleFocus} className={inputClass} />
                                        {maxNpsEmployer > 0 && (
                                            <p className="text-xs text-blue-600 mt-1">
                                                {t('npsEmployerLimitNote', { amount: money(maxNpsEmployer) })}
                                            </p>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <div className={`${cardClass} ${presumptive || Number(ltaReceived) === 0 ? 'opacity-50' : ''}`}>
                                <h3 className="text-xl font-semibold mb-4 border-b pb-2">{t('ltaExemptionTitle')}</h3>
                                <p className="text-xs text-gray-500 -mt-2 mb-4">
                                   {t('ltaExemptionHint')}
                                </p>
                                <div className="grid sm:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">{t('journeysClaimedLabel')}</label>
                                        <select value={ltaJourneysClaimed} onChange={e => setLtaJourneysClaimed(e.target.value)} className={inputClass} disabled={presumptive || Number(ltaReceived) === 0}>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                        </select>
                                    </div>
                                     <div>
                                        <label className="block text-sm font-medium mb-1">{t('eligibleTravelExpensesLabel')}</label>
                                         <p className="text-xs text-gray-500 mb-1">{t('fareHint')}</p>
                                        <input type="text" inputMode="numeric" pattern="\d*" value={ltaActualExpenses} onChange={handleNumericStringChange(setLtaActualExpenses)} onBlur={handleBlur(setLtaActualExpenses)} onFocus={handleFocus} className={inputClass} disabled={presumptive || Number(ltaReceived) === 0 || ltaJourneysClaimed === '0'} />
                                    </div>
                                </div>
                                 {results.ltaExemption > 0 && (
                                        <div className="text-sm sm:col-span-2 mt-4">
                                            <p className="font-semibold text-green-700">
                                                {t('calculatedLtaExemption')} {money(results.ltaExemption)}
                                                <button 
                                                    onClick={() => setShowLtaBreakdown(!showLtaBreakdown)}
                                                    className="ml-2 text-xs text-blue-600 hover:underline focus:outline-none"
                                                    aria-expanded={showLtaBreakdown}
                                                >
                                                    ({showLtaBreakdown ? t('hideCalculation') : t('showCalculation')})
                                                </button>
                                            </p>
                                            {showLtaBreakdown && (
                                                <div className="mt-2 p-3 bg-gray-50 rounded-lg border text-xs text-gray-700 space-y-1">
                                                    <p className="font-semibold">{t('ltaLowestOf')}</p>
                                                    <div className={`flex justify-between ${results.ltaExemption === results.ltaReceivedNum ? 'font-bold text-blue-700' : ''}`}>
                                                        <span>{t('ltaReceivedFromEmployer')}</span>
                                                        <span>{money(results.ltaReceivedNum)}</span>
                                                    </div>
                                                    <div className={`flex justify-between ${results.ltaExemption === results.ltaActualExpensesNum ? 'font-bold text-blue-700' : ''}`}>
                                                        <span>{t('eligibleTravelExpenses')}</span>
                                                        <span>{money(results.ltaActualExpensesNum)}</span>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                            </div>
                            
                            <div className={`${cardClass} ${presumptive ? 'opacity-50' : ''}`}>
                                 <h3 className="text-xl font-semibold mb-4 border-b pb-2">{t('deductionsTitle')}</h3>
                                 <div className="grid sm:grid-cols-2 gap-4">
                                     <div>
                                        <label className="block text-sm font-medium mb-1">{t('ded80CLabel')}</label>
                                        <input type="text" inputMode="numeric" pattern="\d*" value={ded80C} onChange={handleNumericStringChange(setDed80C, remaining80C_limit)} onBlur={handleBlur(setDed80C)} onFocus={handleFocus} className={inputClass} disabled={presumptive} />
                                        {(ded80CNum > 0 || ded80CCD1Num > 0) && (
                                            <p className="text-xs text-blue-600 mt-1" dangerouslySetInnerHTML={{ __html: t('sharedLimitNoteInitial', { claimedVal: money(ded80CCD1Num), claimedSec: '80CCD(1)', otherSec: '80C', limitVal: money(remaining80C_limit) }) }} />
                                        )}
                                     </div>
                                     <div><label className="block text-sm font-medium mb-1">{t('ded80DLabel', {amount: money(max80D)})}</label><input type="text" inputMode="numeric" pattern="\d*" value={ded80D} onChange={handleNumericStringChange(setDed80D, max80D)} onBlur={handleBlur(setDed80D)} onFocus={handleFocus} className={inputClass} disabled={presumptive}/></div>
                                     <div><label className="block text-sm font-medium mb-1">{t('ded80GLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={ded80G} onChange={handleNumericStringChange(setDed80G)} onBlur={handleBlur(setDed80G)} onFocus={handleFocus} className={inputClass} disabled={presumptive}/></div>
                                     <div><label className="block text-sm font-medium mb-1">{t('ded80TTALabel', { amount: money(max80TTA) })}</label><input type="text" inputMode="numeric" pattern="\d*" value={ded80TTA} onChange={handleNumericStringChange(setDed80TTA, max80TTA)} onBlur={handleBlur(setDed80TTA)} onFocus={handleFocus} className={inputClass} disabled={presumptive}/></div>
                                     <div><label className="block text-sm font-medium mb-1">{t('ded80ELabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={ded80E} onChange={handleNumericStringChange(setDed80E)} onBlur={handleBlur(setDed80E)} onFocus={handleFocus} className={inputClass} disabled={presumptive}/></div>
                                     <div><label className="block text-sm font-medium mb-1">{t('ded80GGLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={ded80GG} onChange={handleNumericStringChange(setDed80GG, 60000)} onBlur={handleBlur(setDed80GG)} onFocus={handleFocus} className={inputClass} disabled={presumptive || Number(hraReceived) > 0}/></div>
                                     <div>
                                        <label className="block text-sm font-medium mb-1">{t('ded80ULabel')}</label>
                                        <select value={ded80U} onChange={e => setDed80U(e.target.value)} className={inputClass} disabled={presumptive}>
                                            <option value="none">{t('ded80UNone')}</option>
                                            <option value="normal">{t('ded80UNormal')}</option>
                                            <option value="severe">{t('ded80USevere')}</option>
                                        </select>
                                     </div>
                                     <div><label className="block text-sm font-medium mb-1">{t('ded80DDBLabel', { amount: money(max80DDB) })}</label><input type="text" inputMode="numeric" pattern="\d*" value={ded80DDB} onChange={handleNumericStringChange(setDed80DDB, max80DDB)} onBlur={handleBlur(setDed80DDB)} onFocus={handleFocus} className={inputClass} disabled={presumptive}/></div>
                                 </div>
                            </div>

                             <div className={cardClass}>
                                <h3 className="text-xl font-semibold mb-4 border-b pb-2">{t('prepaidTaxesTitle')}</h3>
                                <div className="grid sm:grid-cols-3 gap-4">
                                    <div><label className="block text-sm font-medium mb-1">{t('tdsLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={tds} onChange={handleNumericStringChange(setTds)} onBlur={handleBlur(setTds)} onFocus={handleFocus} className={inputClass} /></div>
                                    <div><label className="block text-sm font-medium mb-1">{t('tcsLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={tcs} onChange={handleNumericStringChange(setTcs)} onBlur={handleBlur(setTcs)} onFocus={handleFocus} className={inputClass} /></div>
                                    <div><label className="block text-sm font-medium mb-1">{t('advanceTaxLabel')}</label><input type="text" inputMode="numeric" pattern="\d*" value={advanceTax} onChange={handleNumericStringChange(setAdvanceTax)} onBlur={handleBlur(setAdvanceTax)} onFocus={handleFocus} className={inputClass} /></div>
                                </div>
                            </div>

                            <div className={`${cardClass} ${presumptive ? 'opacity-50' : ''}`}>
                                 <h3 className="text-xl font-semibold mb-4 border-b pb-2">{t('incomeFromHousePropertyTitle')}</h3>
                                <div className="space-y-6">
                                    {properties.map((prop, index) => {
                                        const isSOP = prop.type === 'sop';
                                        const interestOnLoanNum = isSOP ? (Number(prop.interestOnLoanSOP) || 0) : 0;
                                        const preConInterestNum = isSOP ? (Number(prop.preConstructionInterest) || 0) : 0;
                                        const cap = isSOP ? (prop.loanTypeSOP === 'purchase' ? 200000 : 30000) : 0;
                                        const remainingAllowance = isSOP ? Math.max(0, cap - interestOnLoanNum) : 0;
                                        const totalInterestClaimed = isSOP ? interestOnLoanNum + preConInterestNum : 0;

                                        return (
                                        <div key={prop.id} className="p-4 border rounded-lg bg-gray-50 relative">
                                            <div className="flex justify-between items-center mb-4">
                                                <h4 className="font-semibold text-lg text-gray-800">{t('propertyLabel', {index: index + 1})}</h4>
                                                {properties.length > 1 && (
                                                    <button onClick={() => removeProperty(prop.id)} className="text-red-500 hover:text-red-700 text-xs font-semibold">{t('removeButton')}</button>
                                                )}
                                            </div>

                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium mb-1">{t('propertyStatusLabel')}</label>
                                                    <select 
                                                        value={prop.type} 
                                                        onChange={e => updateProperty(prop.id, { type: e.target.value })}
                                                        className={inputClass} 
                                                        disabled={presumptive}
                                                    >
                                                        <option value="sop">{t('sopOption')}</option>
                                                        <option value="lop">{t('lopOption')}</option>
                                                    </select>
                                                    {sopCount > 2 && prop.type === 'sop' && (
                                                        <p className="text-xs text-red-600 mt-1">{t('sopWarning')}</p>
                                                    )}
                                                </div>

                                                {prop.type === 'lop' ? (
                                                    <>
                                                        <div className="md:col-span-2 space-y-4">
                                                            <div>
                                                                <div className="flex items-center">
                                                                    <input
                                                                        type="checkbox"
                                                                        id={`gav-toggle-${prop.id}`}
                                                                        checked={prop.useDetailedGAV}
                                                                        onChange={e => updateProperty(prop.id, { useDetailedGAV: e.target.checked })}
                                                                        className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                                                        disabled={presumptive}
                                                                    />
                                                                    <label htmlFor={`gav-toggle-${prop.id}`} className="ml-2 block text-sm font-medium">{t('calculateGAVToggle')}</label>
                                                                </div>
                                                            </div>

                                                            {prop.useDetailedGAV ? (
                                                                <>
                                                                    <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg grid sm:grid-cols-2 gap-4">
                                                                        <h5 className="sm:col-span-2 text-md font-semibold text-gray-700 -mb-2">{t('detailedGAVTitle')}</h5>
                                                                         <div>
                                                                            <label className="flex items-center text-sm font-medium mb-1">{t('municipalValueLabel')} {infoTooltip(t('municipalValueTooltip'))}</label>
                                                                            <input type="text" inputMode="numeric" pattern="\d*" value={prop.municipalValue} onChange={e => updateProperty(prop.id, { municipalValue: e.target.value.replace(/\D/g, '')})} onBlur={e => e.target.value === '' && updateProperty(prop.id, { municipalValue: '0' })} onFocus={handleFocus} className={inputClass} disabled={presumptive} />
                                                                         </div>
                                                                         <div>
                                                                            <label className="flex items-center text-sm font-medium mb-1">{t('fairRentLabel')} {infoTooltip(t('fairRentTooltip'))}</label>
                                                                            <input type="text" inputMode="numeric" pattern="\d*" value={prop.fairRent} onChange={e => updateProperty(prop.id, { fairRent: e.target.value.replace(/\D/g, '')})} onBlur={e => e.target.value === '' && updateProperty(prop.id, { fairRent: '0' })} onFocus={handleFocus} className={inputClass} disabled={presumptive} />
                                                                         </div>
                                                                         <div>
                                                                            <label className="flex items-center text-sm font-medium mb-1">{t('standardRentLabel')} {infoTooltip(t('standardRentTooltip'))}</label>
                                                                            <input type="text" inputMode="numeric" pattern="\d*" value={prop.standardRent} onChange={e => updateProperty(prop.id, { standardRent: e.target.value.replace(/\D/g, '')})} onBlur={e => e.target.value === '' && updateProperty(prop.id, { standardRent: '0' })} onFocus={handleFocus} className={inputClass} disabled={presumptive} />
                                                                         </div>
                                                                         <div>
                                                                            <label className="flex items-center text-sm font-medium mb-1">{t('actualRentLabel')} {infoTooltip(t('actualRentTooltip'))}</label>
                                                                            <input type="text" inputMode="numeric" pattern="\d*" value={prop.actualRent} onChange={e => updateProperty(prop.id, { actualRent: e.target.value.replace(/\D/g, '')})} onBlur={e => e.target.value === '' && updateProperty(prop.id, { actualRent: '0' })} onFocus={handleFocus} className={inputClass} disabled={presumptive} />
                                                                         </div>
                                                                    </div>
                                                                    {(() => {
                                                                        const municipalValue = Number(prop.municipalValue) || 0;
                                                                        const fairRent = Number(prop.fairRent) || 0;
                                                                        const standardRent = Number(prop.standardRent) || 0;
                                                                        const actualRent = Number(prop.actualRent) || 0;
                                                                        const higherOfMVFR = Math.max(municipalValue, fairRent);
                                                                        const expectedRent = standardRent > 0 ? Math.min(higherOfMVFR, standardRent) : higherOfMVFR;
                                                                        const calculatedGAV = Math.max(expectedRent, actualRent);

                                                                        return (
                                                                            <div className="mt-2 p-3 bg-white border border-gray-300 rounded-lg shadow-sm">
                                                                                <h5 className="text-md font-semibold text-gray-800 mb-2 text-center">{t('gavSummaryTitle')}</h5>
                                                                                <div className="text-sm space-y-1 text-gray-900">
                                                                                    <div className="flex justify-between"><span>{t('gavSummaryMV')}</span><span>{money(municipalValue)}</span></div>
                                                                                    <div className="flex justify-between"><span>{t('gavSummaryFR')}</span><span>{money(fairRent)}</span></div>
                                                                                    <div className="flex justify-between border-t pt-1 mt-1"><span>{t('gavSummaryHigher1')}</span><span>{money(higherOfMVFR)}</span></div>
                                                                                    <div className="flex justify-between"><span>{t('gavSummarySR')}</span><span>{money(standardRent)}</span></div>
                                                                                    <div className="flex justify-between font-semibold border-t pt-1 mt-1"><span>{t('gavSummaryER')}</span><span>{money(expectedRent)}</span></div>
                                                                                    <div className="flex justify-between"><span>{t('gavSummaryAR')}</span><span>{money(actualRent)}</span></div>
                                                                                    <div className="flex justify-between font-bold text-blue-700 border-t pt-1 mt-1 text-base bg-blue-50 p-2 rounded-md">
                                                                                        <span>{t('gavSummaryFinal')}</span>
                                                                                        <span>{money(calculatedGAV)}</span>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        );
                                                                    })()}
                                                                </>
                                                            ) : (
                                                                <div>
                                                                    <label className="flex items-center text-sm font-medium mb-1">{t('gavLabel')} {infoTooltip(t('gavTooltip'))}</label>
                                                                    <input type="text" inputMode="numeric" pattern="\d*" value={prop.gav} onChange={e => updateProperty(prop.id, { gav: e.target.value.replace(/\D/g, '')})} onBlur={e => e.target.value === '' && updateProperty(prop.id, { gav: '0' })} onFocus={handleFocus} className={inputClass} disabled={presumptive} />
                                                                </div>
                                                            )}
                                                             <div>
                                                                <label className="flex items-center text-sm font-medium mb-1">{t('municipalTaxesLabel')} {infoTooltip(t('municipalTaxesTooltip'))}</label>
                                                                <input type="text" inputMode="numeric" pattern="\d*" value={prop.municipalTaxes} onChange={e => updateProperty(prop.id, { municipalTaxes: e.target.value.replace(/\D/g, '')})} onBlur={e => e.target.value === '' && updateProperty(prop.id, { municipalTaxes: '0' })} onFocus={handleFocus} className={inputClass} disabled={presumptive} />
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="md:col-span-2 grid sm:grid-cols-2 gap-4">
                                                            <div>
                                                                <label className="block text-sm font-medium mb-1">{t('lopInterestLabel')}</label>
                                                                <p className="text-xs text-gray-500 mb-1">{t('lopInterestHint')}</p>
                                                                <input type="text" inputMode="numeric" pattern="\d*" value={prop.interestOnLoanLOP} onChange={e => updateProperty(prop.id, { interestOnLoanLOP: e.target.value.replace(/\D/g, '')})} onBlur={e => e.target.value === '' && updateProperty(prop.id, { interestOnLoanLOP: '0' })} onFocus={handleFocus} className={inputClass} disabled={presumptive} />
                                                            </div>
                                                             <div>
                                                                <label className="flex items-center text-sm font-medium mb-1">{t('preConInterestLabel')} {infoTooltip(t('preConInterestTooltipLOP'))}</label>
                                                                 <p className="text-xs text-gray-500 mb-1">{t('preConInterestHint')}</p>
                                                                <input type="text" inputMode="numeric" pattern="\d*" value={prop.preConstructionInterest} onChange={e => updateProperty(prop.id, { preConstructionInterest: e.target.value.replace(/\D/g, '')})} onBlur={e => e.target.value === '' && updateProperty(prop.id, { preConstructionInterest: '0' })} onFocus={handleFocus} className={inputClass} disabled={presumptive} />
                                                            </div>
                                                        </div>

                                                    </>
                                                ) : (
                                                    <div className="md:col-span-2 grid sm:grid-cols-2 gap-4">
                                                        <div>
                                                            <label className="block text-sm font-medium mb-1">{t('sopInterestLabel')}</label>
                                                            <p className="text-xs text-gray-500 mb-1">{t('sopInterestHint', { cap: prop.loanTypeSOP === 'purchase' ? '₹2,00,000' : '₹30,000' })}</p>
                                                            <input type="text" inputMode="numeric" pattern="\d*" value={prop.interestOnLoanSOP} onChange={e => handleSOPInterestChange(prop.id, e.target.value)} onBlur={e => e.target.value === '' && updateProperty(prop.id, { interestOnLoanSOP: '0' })} onFocus={handleFocus} className={inputClass} disabled={presumptive} />
                                                            <div className="mt-2 flex flex-wrap gap-x-4 gap-y-1 text-xs sm:text-sm">
                                                                <label className="flex items-center"><input type="radio" value="purchase" name={`loanType-${prop.id}`} checked={prop.loanTypeSOP === 'purchase'} onChange={e => updateProperty(prop.id, { loanTypeSOP: 'purchase' })} className="mr-1.5 h-4 w-4" disabled={presumptive}/>{t('loanTypePurchase')}</label>
                                                                <label className="flex items-center"><input type="radio" value="repair" name={`loanType-${prop.id}`} checked={prop.loanTypeSOP === 'repair'} onChange={e => updateProperty(prop.id, { loanTypeSOP: 'repair', preConstructionInterest: '0' })} className="mr-1.5 h-4 w-4" disabled={presumptive}/>{t('loanTypeRepair')}</label>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label className="flex items-center text-sm font-medium mb-1">{t('preConInterestLabel')} {infoTooltip(t('preConInterestTooltipSOP'))}</label>
                                                             <p className="text-xs text-gray-500 mb-1">{t('sopPreConInterestHint')}</p>
                                                            <input type="text" inputMode="numeric" pattern="\d*" value={prop.preConstructionInterest} onChange={e => handleSOPPreConInterestChange(prop.id, e.target.value)} onBlur={e => e.target.value === '' && updateProperty(prop.id, { preConstructionInterest: '0' })} onFocus={handleFocus} className={inputClass} disabled={presumptive || prop.loanTypeSOP === 'repair'} />
                                                            {prop.loanTypeSOP === 'purchase' && (
                                                                <p className="text-xs text-blue-600 mt-1" dangerouslySetInnerHTML={{ __html: t('sopRemainingAllowance', { amount: money(remainingAllowance) }) }} />
                                                            )}
                                                        </div>
                                                        <div className="sm:col-span-2 p-2 bg-blue-50 border border-blue-200 rounded text-center text-sm">
                                                            <span className="font-semibold">{t('sopTotalInterestClaimed')} </span>
                                                            <span className={`font-bold ${totalInterestClaimed > cap ? 'text-red-600' : 'text-green-700'}`}>
                                                                {money(totalInterestClaimed)}
                                                            </span> / {money(cap)}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        );
                                    })}
                                    <button onClick={addProperty} className="w-full text-blue-600 hover:text-blue-800 font-semibold py-2 px-4 border border-blue-500 rounded hover:bg-blue-50 transition-colors" disabled={presumptive}>
                                        {t('addPropertyButton')}
                                    </button>
                                    <hr className="my-2" />
                                    <div>
                                        <label className="flex items-center text-sm font-medium mb-1">{t('broughtForwardLossLabel')} {infoTooltip(t('broughtForwardLossTooltip'))}</label>
                                        <p className="text-xs text-gray-500 mb-1">{t('broughtForwardLossHint')}</p>
                                        <input type="text" inputMode="numeric" pattern="\d*" value={broughtForwardLossHP} onChange={handleNumericStringChange(setBroughtForwardLossHP)} onBlur={handleBlur(setBroughtForwardLossHP)} onFocus={handleFocus} className={inputClass} disabled={presumptive} />
                                    </div>
                                </div>

                                {properties.length > 0 && (
                                    <div className="text-sm mt-4">
                                        <div className="p-3 bg-gray-100 rounded-lg">
                                            <div className="flex justify-between items-center">
                                                <p className={`text-lg font-semibold`}>{t('netTaxableHPOld')}</p>
                                                <p className={`text-lg font-semibold ${results.hpIncomeOldRegime >= 0 ? 'text-green-700' : 'text-red-700'}`}>
                                                    {money(results.hpIncomeOldRegime)}
                                                </p>
                                            </div>
                                            <div className="flex justify-between items-center mt-2">
                                                <p className={`text-lg font-semibold`}>{t('netTaxableHPNew')}</p>
                                                <p className={`text-lg font-semibold text-green-700`}>
                                                    {money(results.hpIncomeNewRegime)}
                                                </p>
                                            </div>
                                        </div>
                                        <div className="flex justify-end">
                                            <button 
                                                onClick={() => setShowHousePropertyBreakdown(!showHousePropertyBreakdown)}
                                                className="mt-1 text-xs text-blue-600 hover:underline focus:outline-none"
                                                aria-expanded={showHousePropertyBreakdown}
                                            >
                                                {t('showFullCalculation', { toggle: showHousePropertyBreakdown ? t('hide') : t('show')})}
                                            </button>
                                        </div>
                                        {showHousePropertyBreakdown && (
                                             <div className="mt-2 p-3 bg-gray-50 rounded-lg border text-xs text-gray-700 space-y-4">
                                                {results.housePropertyBreakdown.breakdowns.map((b, index) => (
                                                    <div key={b.id}>
                                                        <p className="font-semibold text-black">{t('hpBreakdownTitle', {index: index + 1, type: b.type})}</p>
                                                        {b.type === 'LOP' ? (
                                                             <>
                                                                <div className="flex justify-between"><span>{t('hpBreakdownGAV')}</span><span>{money(b.gav)}</span></div>
                                                                <div className="flex justify-between"><span>{t('hpBreakdownMunicipalTaxes')}</span><span>- {money(b.municipalTaxes)}</span></div>
                                                                <div className="flex justify-between font-semibold"><span>{t('hpBreakdownNAV')}</span><span>{money(b.nav)}</span></div>
                                                                <div className="flex justify-between"><span>{t('hpBreakdownStdDed')}</span><span>- {money(b.standardDeduction)}</span></div>
                                                                <div className="flex justify-between"><span>{t('hpBreakdownInterest')}</span><span>- {money(b.totalInterest)}</span></div>
                                                                <div className={`flex justify-between font-bold border-t pt-1 mt-1 ${b.income >= 0 ? '' : 'text-red-600'}`}><span>{t('hpBreakdownIncomeLoss')}</span><span>{money(b.income)}</span></div>
                                                             </>
                                                        ) : (
                                                            b.isCounted ? (
                                                                <>
                                                                    <div className="flex justify-between"><span>{t('hpBreakdownSOPInterest')}</span><span>{money(b.totalInterest)}</span></div>
                                                                    <div className="flex justify-between font-bold"><span>{t('hpBreakdownSOPLoss', {cap: money(b.interestCap)})}</span><span className="text-red-600">{money(b.loss)}</span></div>
                                                                </>
                                                            ) : <p className="text-gray-500">{t('hpBreakdownSOPNote', { note: b.note})}</p>
                                                        )}
                                                    </div>
                                                ))}
                                                <div className="border-t pt-2 mt-2">
                                                    <p className="font-semibold text-black pt-2">{t('hpFinalCalcTitle')}</p>
                                                    <div className="flex justify-between"><span>{t('hpFinalCalcCurrentYear')}</span><span>{money(results.housePropertyBreakdown.totalHPIncomeBeforeBFLoss)}</span></div>
                                                    {results.housePropertyBreakdown.broughtForwardLossApplied > 0 && <div className="flex justify-between"><span>{t('hpFinalCalcBFLoss')}</span><span>- {money(results.housePropertyBreakdown.broughtForwardLossApplied)}</span></div>}
                                                    <div className="flex justify-between"><span>{t('hpFinalCalcTotalIncomeLoss')}</span><span>{money(results.housePropertyBreakdown.totalHousePropertyIncomeUncapped_Old)}</span></div>

                                                    {results.housePropertyBreakdown.isCapped &&
                                                        <p className="text-xs text-gray-500 pl-2">{t('hpFinalCalcCappedNote')}</p>
                                                    }
                                                     <div className="flex justify-between font-bold text-blue-700 border-t pt-1 mt-1"><span>{t('hpFinalCalcNetAmount')}</span><span>{money(results.hpIncomeOldRegime)}</span></div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                            
                            <div className={cardClass}>
                                <h3 className="text-xl font-semibold mb-4 border-b pb-2 flex items-center">
                                    {t('agniveerTitle')}
                                    {infoTooltip(t('agniveerTooltip'))}
                                </h3>
                                <div className="grid sm:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">{t('agniveerYourContributionLabel')}</label>
                                        <p className="text-xs text-gray-500 mb-1">{t('agniveerYourContributionHint')}</p>
                                        <input type="text" inputMode="numeric" pattern="\d*" value={agniveerContribution} onChange={handleNumericStringChange(setAgniveerContribution)} onBlur={handleBlur(setAgniveerContribution)} onFocus={handleFocus} className={inputClass} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">{t('agniveerGovtContributionLabel')}</label>
                                        <p className="text-xs text-gray-500 mb-1">{t('agniveerGovtContributionHint')}</p>
                                        <input type="text" inputMode="numeric" pattern="\d*" value={govtAgniveerContribution} onChange={handleNumericStringChange(setGovtAgniveerContribution)} onBlur={handleBlur(setGovtAgniveerContribution)} onFocus={handleFocus} className={inputClass} />
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div className="lg:col-span-2 flex flex-col gap-6 lg:sticky lg:top-6">
                             <div className={`${cardClass} border-2 ${results.suggestion === 'Old Regime' ? 'border-blue-500' : results.suggestion === 'New Regime' ? 'border-red-500' : 'border-gray-300'}`}>
                                <h3 className="text-xl font-semibold mb-4">{t('summaryTitle')}</h3>
                                <div className="text-center mb-4 p-2 rounded-lg bg-gray-100">
                                    <p>{t('suggestedRegime')} <span className="font-bold text-lg">{results.suggestion === 'Tie' ? 'Tie' : results.suggestion}</span></p>
                                    {savings > 0 && (
                                        <p className="text-sm text-green-700 font-semibold mt-1">
                                            {t('yourSavingIs', { amount: money(savings), regime: results.suggestion })}
                                        </p>
                                    )}
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {/* Old Regime Summary */}
                                    <div className="text-center p-4 rounded-lg bg-blue-50 space-y-1">
                                        <h4 className="font-bold text-blue-700 text-lg">{t('oldRegimeTitle')}</h4>
                                        <p className="text-2xl font-bold">{money(results.totalTaxOld)}</p>
                                        <div className="text-xs text-gray-600 text-left px-2 pt-2 border-t mt-2 space-y-1">
                                            <div className="flex justify-between"><span>{t('grossIncomeLabel')}</span> <span>{money(grossIncome)}</span></div>
                                             {Number(agriculturalIncome) > 0 && (
                                                <div className="flex justify-between text-gray-500">
                                                    <span>{t('agriculturalIncomeLabel')}</span> 
                                                    <span>{money(Number(agriculturalIncome))}</span>
                                                </div>
                                            )}
                                            {results.hpIncomeOldRegime !== 0 && (
                                                <div className={`flex justify-between ${results.hpIncomeOldRegime < 0 ? 'text-red-600' : ''}`}>
                                                    <span>{t('hpIncomeLossLabel')}</span>
                                                    <span>{results.hpIncomeOldRegime < 0 ? `- ${moneyAbs(results.hpIncomeOldRegime)}` : `+ ${money(results.hpIncomeOldRegime)}`}</span>
                                                </div>
                                            )}
                                            <div className="flex justify-between font-bold border-t pt-1 mt-1"><span>{t('gtiLabel')}</span> <span>{money(results.grossTotalIncomeOld)}</span></div>
                                            
                                            {results.standardDeductionAppliedOld > 0 && <div className="flex justify-between"><span>{t('stdDedLabel')}</span> <span>- {money(results.standardDeductionAppliedOld)}</span></div>}
                                            {results.hraExemption > 0 && <div className="flex justify-between"><span>{t('hraExemptionLabel')}</span> <span>- {money(results.hraExemption)}</span></div>}
                                            {results.ltaExemption > 0 && <div className="flex justify-between"><span>{t('ltaExemptionLabel')}</span> <span>- {money(results.ltaExemption)}</span></div>}
                                            {results.professionalTaxApplied > 0 && <div className="flex justify-between"><span>{t('profTaxLabel')}</span> <span>- {money(results.professionalTaxApplied)}</span></div>}
                                            {results.actualDeduction80C > 0 && <div className="flex justify-between"><span>{t('ded80CLabel')}</span> <span>- {money(results.actualDeduction80C)}</span></div>}
                                            {results.actualDeduction80CCD1 > 0 && <div className="flex justify-between"><span>{t('ded80CCD1Label')}</span> <span>- {money(results.actualDeduction80CCD1)}</span></div>}
                                            {results.npsEmployerApplied > 0 && <div className="flex justify-between"><span>{t('employerNPSLabel')}</span> <span>- {money(results.npsEmployerApplied)}</span></div>}
                                            {results.nps80CCD1BApplied > 0 && <div className="flex justify-between"><span>{t('voluntaryNPSLabel')}</span> <span>- {money(results.nps80CCD1BApplied)}</span></div>}
                                            {results.yourAgniveerContributionApplied > 0 && <div className="flex justify-between"><span>{t('yourAgniveerLabel')}</span> <span>- {money(results.yourAgniveerContributionApplied)}</span></div>}
                                            {results.govtAgniveerContributionApplied > 0 && <div className="flex justify-between"><span>{t('govtAgniveerLabel')}</span> <span>- {money(results.govtAgniveerContributionApplied)}</span></div>}
                                            {results.otherChapVIADeductions > 0 && <div className="flex justify-between"><span>{t('chapVIADedLabel')}</span> <span>- {money(results.otherChapVIADeductions)}</span></div>}

                                            <div className="flex justify-between font-bold mt-1 border-t pt-1"><span>{t('taxableIncomeLabel')}</span> <span>{money(results.taxableOld)}</span></div>
                                            {totalPrepaidTaxes > 0 && <div className="flex justify-between text-green-700 mt-1 border-t pt-1"><span>{t('prepaidTaxesLabel')}</span> <span>- {money(totalPrepaidTaxes)}</span></div>}
                                        </div>
                                    </div>
                                    {/* New Regime Summary */}
                                    <div className="text-center p-4 rounded-lg bg-red-50 space-y-1">
                                        <h4 className="font-bold text-red-700 text-lg">{t('newRegimeTitle')}</h4>
                                        <p className="text-2xl font-bold">{money(results.totalTaxNew)}</p>
                                        <div className="text-xs text-gray-600 text-left px-2 pt-2 border-t mt-2 space-y-1">
                                            <div className="flex justify-between"><span>{t('grossIncomeLabel')}</span><span>{money(grossIncome)}</span></div>
                                            {results.hpIncomeNewRegime > 0 && (
                                                <div className="flex justify-between"><span>{t('hpIncomeLossLabel')}</span><span>+ {money(results.hpIncomeNewRegime)}</span></div>
                                            )}
                                            <div className="flex justify-between font-bold border-t pt-1 mt-1"><span>{t('gtiLabel')}</span><span>{money(results.grossTotalIncomeNew)}</span></div>
                                            
                                            {results.standardDeductionAppliedNew > 0 && <div className="flex justify-between"><span>{t('stdDedLabel')}</span> <span>- {money(results.standardDeductionAppliedNew)}</span></div>}
                                            {results.npsEmployerApplied > 0 && <div className="flex justify-between"><span>{t('employerNPSLabel')}</span> <span>- {money(results.npsEmployerApplied)}</span></div>}
                                            {results.govtAgniveerContributionAppliedNew > 0 && <div className="flex justify-between"><span>{t('govtAgniveerLabel')}</span> <span>- {money(results.govtAgniveerContributionAppliedNew)}</span></div>}

                                            <div className="flex justify-between font-bold mt-1 border-t pt-1"><span>{t('taxableIncomeLabel')}</span> <span>{money(results.taxableNew)}</span></div>
                                            {totalPrepaidTaxes > 0 && <div className="flex justify-between text-green-700 mt-1 border-t pt-1"><span>{t('prepaidTaxesLabel')}</span> <span>- {money(totalPrepaidTaxes)}</span></div>}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className={cardClass}>
                                 <h3 className="text-xl font-semibold mb-2">{t('finalCalcTitle')}</h3>
                                 <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                                    {/* Old Regime Final Calc */}
                                    <div className="space-y-1">
                                        <h4 className="font-semibold text-blue-700 text-lg text-center">{t('oldRegimeTitle')}</h4>
                                        <hr className="my-2"/>
                                        <div className="text-sm flex justify-between items-start gap-2">
                                            <span>
                                                {t('taxOnNormalIncome')}
                                                <button
                                                    onClick={() => setShowOldTaxBreakdown(!showOldTaxBreakdown)}
                                                    className="ml-2 text-xs text-blue-600 hover:underline focus:outline-none"
                                                    aria-expanded={showOldTaxBreakdown}
                                                >
                                                    {t('showBreakup', {toggle: showOldTaxBreakdown ? t('hide') : t('show')})}
                                                </button>
                                            </span>
                                            <span className="text-right whitespace-nowrap">{money(results.slabTaxOldVal)}</span>
                                        </div>
                                        {showOldTaxBreakdown && (
                                            <div className="my-2 p-2 bg-gray-50 rounded border text-xs text-gray-700 space-y-1">
                                                {results.slabTaxOldBreakdown.length > 0 ? (
                                                    results.slabTaxOldBreakdown.map((slab, index) => (
                                                        <div key={index} className="flex justify-between items-start gap-2">
                                                            <span>{slab.range} {slab.rate && ` @ ${slab.rate}`}:</span>
                                                            <span className="text-right whitespace-nowrap">{money(slab.tax)}</span>
                                                        </div>
                                                    ))
                                                ) : <p>{t('noSlabTax')}</p>}
                                                <hr className="my-1"/>
                                                <div className="font-bold flex justify-between">
                                                    <span>{t('totalSlabTax')}</span>
                                                    <span>{money(results.slabTaxOldVal)}</span>
                                                </div>
                                            </div>
                                        )}
                                        <div className="text-sm flex justify-between items-start"><span>{t('taxOnLTCG')}</span> <span className="whitespace-nowrap">{money(results.taxLtcgVal)}</span></div>
                                        <div className="text-sm flex justify-between items-start"><span>{t('taxOnSTCG')}</span> <span className="whitespace-nowrap">{money(results.taxStcgVal)}</span></div>
                                        <div className="text-sm flex justify-between items-start"><span>{t('taxOnCrypto')}</span> <span className="whitespace-nowrap">{money(results.taxOnCryptoVal)}</span></div>
                                        <div className="font-semibold border-t pt-1 mt-1 flex justify-between"><span>{t('taxBeforeSurcharge')}</span> <span className="whitespace-nowrap">{money(results.slabTaxOldVal + results.capitalGainsTax + results.taxOnCryptoVal)}</span></div>
                                        
                                        {results.surchargeOld > 0 && <div className="text-sm flex justify-between items-start"><span>{t('surchargeLabel', {rate: results.surchargeRateOld * 100})}</span> <span className="whitespace-nowrap">{money(results.surchargeOld)}</span></div>}
                                        {results.marginalReliefOld > 0 && <div className="text-sm flex justify-between items-start text-green-600"><span>{t('marginalReliefLabel')}</span> <span className="whitespace-nowrap">- {money(results.marginalReliefOld)}</span></div>}
                                        <div className="font-semibold flex justify-between"><span>{t('taxBeforeCess')}</span> <span className="whitespace-nowrap">{money(results.taxAfterSurchargeAndReliefOld)}</span></div>
                                        <div className="text-sm flex justify-between items-start"><span>{t('cessLabel')}</span> <span className="whitespace-nowrap">{money(results.cessOld)}</span></div>
                                        <div className="text-sm font-bold border-t pt-1 mt-1 flex justify-between items-start"><span>{t('totalTaxPayable')}</span> <span className="whitespace-nowrap">{money(results.totalTaxOld)}</span></div>
                                        
                                        <div className="text-sm mt-2 flex justify-between items-start"><span>{t('lessTDS')}</span> <span className="whitespace-nowrap">{money(Number(tds))}</span></div>
                                        <div className="text-sm flex justify-between items-start"><span>{t('lessTCS')}</span> <span className="whitespace-nowrap">{money(Number(tcs))}</span></div>
                                        <div className="text-sm flex justify-between items-start"><span>{t('lessAdvanceTax')}</span> <span className="whitespace-nowrap">{money(Number(advanceTax))}</span></div>
                                        <div className="text-sm font-bold border-t pt-1 mt-1 flex justify-between items-start"><span>{t('totalPrepaidTax')}</span> <span className="whitespace-nowrap">{money(totalPrepaidTaxes)}</span></div>
                                        
                                        <div className={`mt-2 p-3 text-center rounded-lg text-white font-bold text-lg ${results.netOld >= 0 ? 'bg-red-500' : 'bg-green-500'}`}>
                                            {results.netOld >= 0 ? t('netPayable') : t('refund')}: {moneyAbs(results.netOld)}
                                        </div>
                                    </div>
                                     {/* New Regime Final Calc */}
                                     <div className="space-y-1">
                                        <h4 className="font-semibold text-red-700 text-lg text-center">{t('newRegimeTitle')}</h4>
                                        <hr className="my-2"/>
                                        <div className="text-sm flex justify-between items-start gap-2">
                                            <span>
                                                {t('taxOnNormalIncome')}
                                                <button
                                                    onClick={() => setShowNewTaxBreakdown(!showNewTaxBreakdown)}
                                                    className="ml-2 text-xs text-blue-600 hover:underline focus:outline-none"
                                                    aria-expanded={showNewTaxBreakdown}
                                                >
                                                    {t('showBreakup', {toggle: showNewTaxBreakdown ? t('hide') : t('show')})}
                                                </button>
                                            </span>
                                            <span className="text-right whitespace-nowrap">{money(results.slabTaxNewVal)}</span>
                                        </div>
                                        {showNewTaxBreakdown && (
                                            <div className="my-2 p-2 bg-gray-50 rounded border text-xs text-gray-700 space-y-1">
                                                {results.slabTaxNewBreakdown.length > 0 ? (
                                                    results.slabTaxNewBreakdown.map((slab, index) => (
                                                        <div key={index} className="flex justify-between items-start gap-2">
                                                            <span>{slab.range} {slab.rate && ` @ ${slab.rate}`}:</span>
                                                            <span className="text-right whitespace-nowrap">{money(slab.tax)}</span>
                                                        </div>
                                                    ))
                                                ) : (
                                                    <p>{t('noSlabTax')}</p>
                                                )}
                                                {(results.slabTaxNewVal > 0 || results.slabTaxNewBreakdown.length > 1) && <hr className="my-1"/>}
                                                <div className="font-bold flex justify-between">
                                                    <span>{t('totalSlabTax')}</span>
                                                    <span>{money(results.slabTaxNewVal)}</span>
                                                </div>
                                            </div>
                                        )}
                                        <div className="text-sm flex justify-between items-start"><span>{t('taxOnLTCG')}</span> <span className="whitespace-nowrap">{money(results.taxLtcgVal)}</span></div>
                                        <div className="text-sm flex justify-between items-start"><span>{t('taxOnSTCG')}</span> <span className="whitespace-nowrap">{money(results.taxStcgVal)}</span></div>
                                        <div className="text-sm flex justify-between items-start"><span>{t('taxOnCrypto')}</span> <span className="whitespace-nowrap">{money(results.taxOnCryptoVal)}</span></div>
                                        <div className="font-semibold border-t pt-1 mt-1 flex justify-between"><span>{t('taxBeforeSurcharge')}</span> <span className="whitespace-nowrap">{money(results.slabTaxNewVal + results.capitalGainsTax + results.taxOnCryptoVal)}</span></div>
                                        
                                        {results.surchargeNew > 0 && <div className="text-sm flex justify-between items-start"><span>{t('surchargeLabel', {rate: results.surchargeRateNew * 100})}</span> <span className="whitespace-nowrap">{money(results.surchargeNew)}</span></div>}
                                        {results.marginalReliefNew > 0 && <div className="text-sm flex justify-between items-start text-green-600"><span>{t('marginalReliefLabel')}</span> <span className="whitespace-nowrap">- {money(results.marginalReliefNew)}</span></div>}
                                        <div className="font-semibold flex justify-between"><span>{t('taxBeforeCess')}</span> <span className="whitespace-nowrap">{money(results.taxAfterSurchargeAndReliefNew)}</span></div>
                                        <div className="text-sm flex justify-between items-start"><span>{t('cessLabel')}</span> <span className="whitespace-nowrap">{money(results.cessNew)}</span></div>
                                        <div className="text-sm font-bold border-t pt-1 mt-1 flex justify-between items-start"><span>{t('totalTaxPayable')}</span> <span className="whitespace-nowrap">{money(results.totalTaxNew)}</span></div>

                                        <div className="text-sm mt-2 flex justify-between items-start"><span>{t('lessTDS')}</span> <span className="whitespace-nowrap">{money(Number(tds))}</span></div>
                                        <div className="text-sm flex justify-between items-start"><span>{t('lessTCS')}</span> <span className="whitespace-nowrap">{money(Number(tcs))}</span></div>
                                        <div className="text-sm flex justify-between items-start"><span>{t('lessAdvanceTax')}</span> <span className="whitespace-nowrap">{money(Number(advanceTax))}</span></div>
                                        <div className="text-sm font-bold border-t pt-1 mt-1 flex justify-between items-start"><span>{t('totalPrepaidTax')}</span> <span className="whitespace-nowrap">{money(totalPrepaidTaxes)}</span></div>
                                        
                                        <div className={`mt-2 p-3 text-center rounded-lg text-white font-bold text-lg ${results.netNew >= 0 ? 'bg-red-500' : 'bg-green-500'}`}>
                                            {results.netNew >= 0 ? t('netPayable') : t('refund')}: {moneyAbs(results.netNew)}
                                        </div>
                                    </div>
                                 </div>
                            </div>
                            
                            <div className={cardClass}>
                                <h3 className="text-xl font-semibold mb-4">{t('taxSavingOppsTitle')}</h3>
                                {presumptive ? (
                                    <p className="mt-4 text-gray-500">{t('plannerDisabledPresumptive')}</p>
                                ) : grossIncome === 0 ? (
                                    <div className="mt-4 p-4 text-center text-gray-500 bg-gray-50 rounded-lg">
                                        <p>{t('plannerEnterIncome')}</p>
                                    </div>
                                ) : (
                                    <div className="mt-4 space-y-4">
                                        {(results.totalTaxOld <= 0 && results.totalTaxNew <= 0) && (
                                             <div className="p-4 text-center text-green-700 bg-green-50 rounded-lg">
                                                <p>{t('plannerNoLiability')}</p>
                                            </div>
                                        )}

                                        {(results.totalTaxOld > 0 || results.totalDeductionsOld > 0 || results.totalExemptionsClaimed > 0) && (
                                            <div className="p-4 rounded-lg bg-blue-50 border border-blue-200">
                                                <h4 className="text-lg font-semibold text-blue-800 mb-2">{t('oldRegimePlannerTitle')}</h4>
                                                <div className="space-y-3">
                                                    {(() => {
                                                        const opps = results.taxSavingOpportunities;
                                                        const hasUnclaimedPotential = opps.potential80CCE > 0 || opps.potentialNPS > 0 || opps.potential80D > 0 || opps.potential80TTA > 0 || opps.potentialProfTax > 0 || opps.potential80GG > 0 || opps.potential80DDB > 0;

                                                        return (
                                                            <>
                                                                {opps.potentialTaxSaving > 0 && results.totalTaxOld > 0 && (
                                                                    <>
                                                                        <p dangerouslySetInnerHTML={{ __html: t('potentialSaving', { amount: `<span class="font-bold text-green-700">${money(opps.potentialTaxSaving)}</span>` }) }} />
                                                                        <div className="p-3 rounded-lg text-center bg-blue-100">
                                                                            <p className="font-semibold" dangerouslySetInnerHTML={{ __html: t('potentialLiability', { amount: `<span class="text-blue-700 font-bold">${money(opps.potentialTotalTaxOld)}</span>` }) }} />
                                                                        </div>
                                                                    </>
                                                                )}

                                                                <div className="bg-gray-50 p-3 rounded-lg">
                                                                    <p className="font-semibold text-center mb-2">{t('currentSavingPicture')}</p>
                                                                    <div className="text-sm space-y-1">
                                                                        {results.totalExemptionsClaimed > 0 && (
                                                                            <>
                                                                                {results.hraExemption > 0 && <div className="flex justify-between"><span>{t('hraExemptionLabel')}</span> <span>{money(results.hraExemption)}</span></div>}
                                                                                {results.ltaExemption > 0 && <div className="flex justify-between"><span>{t('ltaExemptionLabel')}</span> <span>{money(results.ltaExemption)}</span></div>}
                                                                                <div className="flex justify-between font-bold border-t pt-1 mt-1">
                                                                                    <span>{t('totalExemptionClaimed')}</span>
                                                                                    <span>{money(results.totalExemptionsClaimed)}</span>
                                                                                </div>
                                                                                <hr className="my-1"/>
                                                                            </>
                                                                        )}
                                                                        <div className="flex justify-between font-bold">
                                                                            <span>{t('totalDeductionClaimed')}</span>
                                                                            <span>{money(results.totalDeductionsOld)}</span>
                                                                        </div>
                                                                        <p className="text-xs text-gray-500 pl-2">{t('deductionsIncludeNote')}</p>
                                                                    </div>
                                                                </div>

                                                                {results.totalTaxOld > 0 && !hasUnclaimedPotential ? (
                                                                    <p className="mt-4 text-green-600 font-semibold">{t('maximizedDeductions')}</p>
                                                                ) : (
                                                                    <>
                                                                        {hasUnclaimedPotential && results.totalTaxOld > 0 && (
                                                                            <>
                                                                                <p className="text-sm font-semibold text-gray-800 pt-2">{t('remainingPotential')}</p>
                                                                                <ul className="list-disc list-inside space-y-1 text-sm text-gray-700">
                                                                                    {opps.potential80CCE > 0 && (
                                                                                        <li>
                                                                                            <span dangerouslySetInnerHTML={{ __html: t('potential80CCE', { amount: `<span class="font-bold">${money(opps.potential80CCE)}</span>` }) }} />
                                                                                            <p className="text-xs text-gray-500 pl-5">{t('potential80CCENote')}</p>
                                                                                        </li>
                                                                                    )}
                                                                                    {opps.potentialNPS > 0 && <li dangerouslySetInnerHTML={{ __html: t('potentialNPS', { amount: `<span class="font-bold">${money(opps.potentialNPS)}</span>` }) }} />}
                                                                                    {opps.potential80D > 0 && <li dangerouslySetInnerHTML={{ __html: t('potential80D', { amount: `<span class="font-bold">${money(opps.potential80D)}</span>` }) }} />}
                                                                                    {opps.potential80TTA > 0 && <li dangerouslySetInnerHTML={{ __html: t('potential80TTA', { amount: `<span class="font-bold">${money(opps.potential80TTA)}</span>` }) }} />}
                                                                                    {opps.potentialProfTax > 0 && <li dangerouslySetInnerHTML={{ __html: t('potentialProfTax', { amount: `<span class="font-bold">${money(opps.potentialProfTax)}</span>` }) }} />}
                                                                                </ul>
                                                                            </>
                                                                        )}
                                                                    </>
                                                                )}

                                                                {results.totalTaxOld > 0 && (
                                                                    <div className="mt-4 pt-3 border-t">
                                                                        <h4 className="text-sm font-semibold text-gray-800">{t('conditionalSavingsTitle')}</h4>
                                                                        <p className="text-xs text-gray-500 mb-2">{t('conditionalSavingsHint')}</p>
                                                                        
                                                                        <div className="flex items-start my-2 text-sm">
                                                                            <input 
                                                                                type="checkbox" 
                                                                                id="opp80GG"
                                                                                checked={Number(ded80GG) > 0}
                                                                                onChange={handle80GGCheckboxChange}
                                                                                disabled={Number(hraReceived) > 0 || presumptive}
                                                                                className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mt-1"
                                                                            />
                                                                            <label htmlFor="opp80GG" className="ml-2">
                                                                                <span dangerouslySetInnerHTML={{ __html: t('opp80GG', { amount: money(opps.potential80GG)})}} />
                                                                                <span className="block text-xs text-gray-500">
                                                                                    {t('opp80GGHint')}
                                                                                    {Number(hraReceived) > 0 && <span className="text-red-500 font-semibold"> {t('opp80GGDisabled')}</span>}
                                                                                </span>
                                                                            </label>
                                                                        </div>

                                                                        <div className="flex items-start my-2 text-sm">
                                                                            <input 
                                                                                type="checkbox" 
                                                                                id="opp80DDB"
                                                                                checked={Number(ded80DDB) > 0}
                                                                                onChange={handle80DDBCheckboxChange}
                                                                                disabled={presumptive}
                                                                                className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mt-1"
                                                                            />
                                                                            <label htmlFor="opp80DDB" className="ml-2">
                                                                                <span dangerouslySetInnerHTML={{ __html: t('opp80DDB', { amount: money(opps.potential80DDB)})}} />
                                                                                <span className="block text-xs text-gray-500">{t('opp80DDBHint')}</span>
                                                                            </label>
                                                                        </div>
                                                                        
                                                                        <div className="mt-2 p-2 bg-blue-100 rounded-lg text-sm text-blue-800" dangerouslySetInnerHTML={{ __html: t('opp80E') }} />
                                                                    </div>
                                                                )}
                                                            </>
                                                        );
                                                    })()}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {(results.totalTaxNew > 0 || results.totalDeductionsNew > 0) && (
                                            <div className="p-4 rounded-lg bg-red-50 border border-red-200">
                                                <h4 className="text-lg font-semibold text-red-800 mb-2">{t('newRegimeOppsTitle')}</h4>
                                                <div className="space-y-3">
                                                    <div className="bg-gray-50 p-3 rounded-lg">
                                                        <p className="font-semibold text-center mb-2">{t('newRegimeOppsPicture')}</p>
                                                        <div className="text-sm space-y-1">
                                                            <div className="flex justify-between font-bold">
                                                                <span>{t('totalDeductionClaimed')}</span>
                                                                <span>{money(results.totalDeductionsNew)}</span>
                                                            </div>
                                                            <p className="text-xs text-gray-500 pl-2">{t('newRegimeOppsDeductionsIncludeNote')}</p>
                                                        </div>
                                                    </div>

                                                    <p className="text-sm text-gray-600 pt-2">{t('newRegimeOppsSummary')}</p>
                                                    <ul className="list-disc list-inside space-y-2 text-sm text-gray-800">
                                                        {results.standardDeductionAppliedNew > 0 && (
                                                            <li dangerouslySetInnerHTML={{ __html: t('newRegimeOppsStdDed', { amount: money(results.standardDeductionAppliedNew) })}} />
                                                        )}
                                                        {results.npsEmployerApplied > 0 && (
                                                             <li dangerouslySetInnerHTML={{ __html: t('newRegimeOppsNPS', { amount: money(results.npsEmployerApplied) })}} />
                                                        )}
                                                        {results.govtAgniveerContributionAppliedNew > 0 && (
                                                             <li dangerouslySetInnerHTML={{ __html: t('newRegimeOppsAgniveer', { amount: money(results.govtAgniveerContributionAppliedNew) })}} />
                                                        )}
                                                        {results.isSalaried && results.npsEmployerApplied === 0 && results.totalTaxNew > 0 && (
                                                            <li>
                                                                <span dangerouslySetInnerHTML={{ __html: t('oppsNPSNewRegimeTitle') }} />
                                                                {infoTooltip(t('oppsNPSNewRegimeTooltip'))}
                                                                <p className="text-xs text-gray-500 mt-1 pl-5">{t('oppsNPSNewRegimeNote')}</p>
                                                            </li>
                                                        )}
                                                    </ul>
                                                    <p className="text-xs text-gray-500 pt-2">{t('newRegimeOppsNote')}</p>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                            
                            <div className={cardClass}>
                                <h3 className="text-xl font-semibold mb-2">{t('itrFormTitle')}</h3>
                                <p className="text-lg font-bold text-green-700">{results.itrSuggestion}</p>
                                <p className="text-sm text-gray-600 mt-1">{results.itrSuggestionReason}</p>
                            </div>

                            <div className={cardClass}>
                                <div className="flex items-center gap-2 mb-4">
                                    <h3 className="text-xl font-semibold">{t('totalTaxComparisonTitle')}</h3>
                                    <div className="relative group">
                                        <span className="flex items-center justify-center h-4 w-4 bg-gray-400 text-white rounded-full text-xs font-bold cursor-help">
                                            i
                                        </span>
                                        <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-80 p-3 bg-gray-700 text-white text-xs rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-opacity duration-300 pointer-events-none z-10">
                                            <p dangerouslySetInnerHTML={{ __html: t('insightTooltip') }} />
                                            <div className="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-gray-700"></div>
                                        </div>
                                    </div>
                                </div>

                                {grossIncome > 0 && (
                                    <div className="space-y-6 text-left mb-4 p-4 bg-gray-50 rounded-lg">
                                        <div>
                                            <p className="font-bold text-blue-700 mb-2 text-lg">{t('oldRegimeTitle')}</p>
                                            <ul className="list-disc list-inside space-y-2 text-xs">
                                                <li className="text-gray-700" dangerouslySetInnerHTML={{ __html: t('insightTax', { months: monthsOfTaxOld.toFixed(1) }) }} />
                                                <li className="text-gray-700" dangerouslySetInnerHTML={{ __html: t('insightDeductions', { months: monthsOfDeductionsOld.toFixed(1) }) }} />
                                                <li className="text-gray-700" dangerouslySetInnerHTML={{ __html: t('insightTakeHome', { months: monthsTakeHomeOld.toFixed(1) }) }} />
                                            </ul>
                                        </div>
                                        
                                        <div>
                                             <p className="font-bold text-red-700 mb-2 text-lg">{t('newRegimeTitle')}</p>
                                             <ul className="list-disc list-inside space-y-2 text-xs">
                                                <li className="text-gray-700" dangerouslySetInnerHTML={{ __html: t('insightTax', { months: monthsOfTaxNew.toFixed(1) }) }} />
                                                <li className="text-gray-700" dangerouslySetInnerHTML={{ __html: t('insightDeductions', { months: monthsOfDeductionsNew.toFixed(1) }) }} />
                                                <li className="text-gray-700" dangerouslySetInnerHTML={{ __html: t('insightTakeHome', { months: monthsTakeHomeNew.toFixed(1) }) }} />
                                            </ul>
                                        </div>
                                    </div>
                                )}
                                <div className="h-48"><canvas ref={canvasRef}></canvas></div>
                            </div>

                            <div className={cardClass}>
                                <h3 className="text-xl font-semibold mb-2">{t('taxSlabRatesTitle')}</h3>
                                <button 
                                    onClick={() => setShowTaxSlabs(!showTaxSlabs)}
                                    className="w-full text-blue-600 hover:text-blue-800 font-semibold py-2 px-4 border border-blue-500 rounded hover:bg-blue-50 transition-colors"
                                    aria-expanded={showTaxSlabs}
                                >
                                    {t('toggleTaxSlabTables', {toggle: showTaxSlabs ? t('hide') : t('show')})}
                                </button>
                                {showTaxSlabs && (
                                     <div className="mt-4 space-y-6 overflow-x-auto">
                                        {/* Old Regime Table */}
                                        <div>
                                            <h4 className="text-lg font-semibold text-blue-700 mb-2">{t('oldTaxRegimeTitle')}</h4>
                                            <table className="min-w-full divide-y divide-gray-200 border">
                                                <thead className="bg-gray-50">
                                                    <tr>
                                                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{t('incomeSlab')}</th>
                                                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{t('below60Col')}</th>
                                                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{t('seniorCol')}</th>
                                                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{t('superSeniorCol')}</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="bg-white divide-y divide-gray-200 text-sm">
                                                    <tr>
                                                        <td className="px-4 py-2 whitespace-nowrap">{t('slabOldRow1')}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap">{t('slabNil')}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap">{t('slabNil')}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap">{t('slabNil')}</td>
                                                    </tr>
                                                    <tr>
                                                        <td className="px-4 py-2 whitespace-nowrap">{t('slabOldRow2')}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap">{t('rate5pc')}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap">{t('slabNil')}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap">{t('slabNil')}</td>
                                                    </tr>
                                                    <tr>
                                                        <td className="px-4 py-2 whitespace-nowrap">{t('slabOldRow3')}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap">{t('rate5pc')}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap">{t('rate5pc')}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap">{t('slabNil')}</td>
                                                    </tr>
                                                    <tr>
                                                        <td className="px-4 py-2 whitespace-nowrap">{t('slabOldRow4')}</td>
                                                        <td colSpan={3} className="px-4 py-2 whitespace-nowrap">{t('rate20pc')}</td>
                                                    </tr>
                                                    <tr>
                                                        <td className="px-4 py-2 whitespace-nowrap">{t('slabOldRow5')}</td>
                                                        <td colSpan={3} className="px-4 py-2 whitespace-nowrap">{t('rate30pc')}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                            <div className="mt-2 p-2 bg-blue-50 rounded text-xs text-gray-700 space-y-1">
                                                <p className="font-semibold">{t('oldRegimeNotesTitle')}</p>
                                                <ul className="list-disc list-inside">
                                                    <li dangerouslySetInnerHTML={{__html: t('oldRegimeNote1')}}/>
                                                    <li dangerouslySetInnerHTML={{__html: t('oldRegimeNote2')}}/>
                                                    <li dangerouslySetInnerHTML={{__html: t('oldRegimeNote3')}}/>
                                                </ul>
                                            </div>
                                        </div>
                                        {/* New Regime Table */}
                                        <div>
                                             <h4 className="text-lg font-semibold text-red-700 mb-2">{t('newTaxRegimeTitle')}</h4>
                                             <table className="min-w-full divide-y divide-gray-200 border">
                                                <thead className="bg-gray-50">
                                                    <tr>
                                                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{t('incomeSlab')}</th>
                                                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{t('taxRateCol')}</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="bg-white divide-y divide-gray-200 text-sm">
                                                    <tr><td className="px-4 py-2">{t('slabNewRow1')}</td><td className="px-4 py-2">{t('slabNil')}</td></tr>
                                                    <tr><td className="px-4 py-2">{t('slabNewRow2')}</td><td className="px-4 py-2">{t('rate5pc')}</td></tr>
                                                    <tr><td className="px-4 py-2">{t('slabNewRow3')}</td><td className="px-4 py-2">{t('rate10pc')}</td></tr>
                                                    <tr><td className="px-4 py-2">{t('slabNewRow4')}</td><td className="px-4 py-2">{t('rate15pc')}</td></tr>
                                                    <tr><td className="px-4 py-2">{t('slabNewRow5')}</td><td className="px-4 py-2">{t('rate20pc')}</td></tr>
                                                    <tr><td className="px-4 py-2">{t('slabNewRow6')}</td><td className="px-4 py-2">{t('rate25pc')}</td></tr>
                                                    <tr><td className="px-4 py-2">{t('slabNewRow7')}</td><td className="px-4 py-2">{t('rate30pc')}</td></tr>
                                                </tbody>
                                            </table>
                                             <div className="mt-2 p-2 bg-red-50 rounded text-xs text-gray-700 space-y-1">
                                                <p className="font-semibold">{t('newRegimeNotesTitle')}</p>
                                                <ul className="list-disc list-inside">
                                                    <li dangerouslySetInnerHTML={{__html: t('newRegimeNote1')}}/>
                                                    <li dangerouslySetInnerHTML={{__html: t('newRegimeNote2')}}/>
                                                    <li dangerouslySetInnerHTML={{__html: t('newRegimeNote3')}}/>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className={cardClass}>
                                <h3 className="text-xl font-semibold mb-2">{t('surchargeTitle')}</h3>
                                <button 
                                    onClick={() => setShowSurchargeRates(!showSurchargeRates)}
                                    className="w-full text-blue-600 hover:text-blue-800 font-semibold py-2 px-4 border border-blue-500 rounded hover:bg-blue-50 transition-colors"
                                    aria-expanded={showSurchargeRates}
                                >
                                    {t('toggleSurchargeTables', {toggle: showSurchargeRates ? t('hide') : t('show')})}
                                </button>
                                {showSurchargeRates && (
                                    <div className="mt-4 space-y-4">
                                        <p className="text-sm text-gray-600" dangerouslySetInnerHTML={{ __html: t('surchargeHint') }} />
                                        <div className="overflow-x-auto">
                                            <table className="min-w-full divide-y divide-gray-200 border">
                                                <thead className="bg-gray-50">
                                                    <tr>
                                                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{t('netTaxableIncomeLimitCol')}</th>
                                                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{t('surchargeOldCol')}</th>
                                                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{t('surchargeNewCol')}</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="bg-white divide-y divide-gray-200 text-sm">
                                                    <tr><td className="px-4 py-2">{t('surchargeRow1')}</td><td className="px-4 py-2">{t('slabNil')}</td><td className="px-4 py-2">{t('slabNil')}</td></tr>
                                                    <tr><td className="px-4 py-2">{t('surchargeRow2')}</td><td className="px-4 py-2">{t('rate10pc')}</td><td className="px-4 py-2">{t('rate10pc')}</td></tr>
                                                    <tr><td className="px-4 py-2">{t('surchargeRow3')}</td><td className="px-4 py-2">{t('rate15pc')}</td><td className="px-4 py-2">{t('rate15pc')}</td></tr>
                                                    <tr><td className="px-4 py-2">{t('surchargeRow4')}</td><td className="px-4 py-2">{t('rate25pc')}</td><td className="px-4 py-2">{t('rate25pc')}</td></tr>
                                                    <tr><td className="px-4 py-2">{t('surchargeRow5')}</td><td className="px-4 py-2">{t('rate37pc')}</td><td className="px-4 py-2">{t('rate25pc')}</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div className="mt-2 p-2 bg-gray-100 rounded text-xs text-gray-700">
                                            <p><strong className="font-semibold">{t('surchargeNotesTitle')}</strong> {t('surchargeNote')}</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>

                    <footer className="mt-8 text-left text-xs text-gray-600 border-t pt-6 space-y-6">
                        <div className="space-y-2">
                            <h4 className="font-bold text-sm text-gray-800">{t('footerAdvisoryTitle')}</h4>
                            <p>{t('footerAdvisoryText')}</p>
                        </div>

                        <div className="space-y-2">
                            <h4 className="font-bold text-sm text-gray-800">{t('footerDisclaimerTitle')}</h4>
                            <p>{t('footerDisclaimerText')}</p>
                        </div>
                        
                        <div className="space-y-2">
                            <div 
                                onClick={() => setIsCopyrightExpanded(!isCopyrightExpanded)}
                                className="cursor-pointer flex justify-between items-center"
                                aria-expanded={isCopyrightExpanded}
                                aria-controls="copyright-details"
                            >
                                <h4 className="font-bold text-sm text-gray-800">{t('footerCopyrightHeader')}</h4>
                                <svg className={`w-4 h-4 text-gray-800 transition-transform duration-300 transform ${isCopyrightExpanded ? 'rotate-180' : ''}`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                   <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>

                            <div 
                                id="copyright-details"
                                className={`transition-all duration-500 ease-in-out overflow-hidden space-y-4 ${isCopyrightExpanded ? 'max-h-[1000px] opacity-100 pt-4' : 'max-h-0 opacity-0'}`}
                            >
                                <p>{t('footerCopyrightWarning')}</p>
                                
                                <div>
                                    <p className="font-semibold">{t('footerInfringementTitle')}</p>
                                    <ul className="list-disc list-inside pl-4 space-y-1">
                                        <li>{t('footerCriminalLiability')}</li>
                                        <li>{t('footerCivilRemedies')}</li>
                                    </ul>
                                </div>
                                
                                <p>{t('footerPermissionNotice')}</p>
                                
                                <div>
                                    <p className="font-semibold">{t('footerDeveloperContactTitle')}</p>
                                    <p>
                                        {t('footerDeveloperContactInfo')} <a href="mailto:ij.indrajit@hotmail.com" className="text-blue-600 hover:underline">ij.indrajit@hotmail.com</a>
                                    </p>
                                </div>
                                
                                <div>
                                    <p className="font-semibold">{t('footerGoverningLawTitle')}</p>
                                    <ul className="list-disc list-inside pl-4 space-y-1">
                                        <li>{t('footerGoverningLawText')}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div className="space-y-2">
                             <div 
                                onClick={() => setIsPrivacyExpanded(!isPrivacyExpanded)}
                                className="cursor-pointer flex justify-between items-center"
                                aria-expanded={isPrivacyExpanded}
                                aria-controls="privacy-details"
                            >
                                <h4 className="font-bold text-sm text-gray-800">{t('footerPrivacyHeader')}</h4>
                                <svg className={`w-4 h-4 text-gray-800 transition-transform duration-300 transform ${isPrivacyExpanded ? 'rotate-180' : ''}`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                   <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>

                            <div
                                id="privacy-details"
                                className={`transition-all duration-500 ease-in-out overflow-hidden space-y-3 ${isPrivacyExpanded ? 'max-h-[1000px] opacity-100 pt-4' : 'max-h-0 opacity-0'}`}
                            >
                                <div>
                                    <p className="font-semibold">{t('footerPrivacyPoint1Title')}</p>
                                    <p>{t('footerPrivacyPoint1Text')}</p>
                                </div>
                                 <div>
                                    <p className="font-semibold">{t('footerPrivacyPoint2Title')}</p>
                                    <p>{t('footerPrivacyPoint2Text')}</p>
                                </div>
                                 <div>
                                    <p className="font-semibold">{t('footerPrivacyPoint3Title')}</p>
                                    <p>{t('footerPrivacyPoint3Text')}</p>
                                </div>
                                 <div>
                                    <p className="font-semibold">{t('footerPrivacyPoint4Title')}</p>
                                    <p>{t('footerPrivacyPoint4Text')}</p>
                                </div>
                            </div>
                        </div>

                        <div className="space-y-2">
                             <div 
                                onClick={() => setIsTermsExpanded(!isTermsExpanded)}
                                className="cursor-pointer flex justify-between items-center"
                                aria-expanded={isTermsExpanded}
                                aria-controls="terms-details"
                            >
                                <h4 className="font-bold text-sm text-gray-800">{t('footerTermsHeader')}</h4>
                                <svg className={`w-4 h-4 text-gray-800 transition-transform duration-300 transform ${isTermsExpanded ? 'rotate-180' : ''}`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                   <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>

                            <div
                                id="terms-details"
                                className={`transition-all duration-500 ease-in-out overflow-hidden space-y-4 ${isTermsExpanded ? 'max-h-[1000px] opacity-100 pt-4' : 'max-h-0 opacity-0'}`}
                            >
                                <p>{t('footerTermsIntro')}</p>
                                <div>
                                    <p className="font-semibold">{t('footerTerms1Title')}</p>
                                    <ul className="list-disc list-inside pl-4 space-y-1">
                                        <li>{t('footerTerms1Point1')}</li>
                                        <li>{t('footerTerms1Point2')}</li>
                                        <li>{t('footerTerms1Point3')}</li>
                                    </ul>
                                </div>
                                <div>
                                    <p className="font-semibold">{t('footerTerms2Title')}</p>
                                    <ul className="list-disc list-inside pl-4 space-y-1">
                                        <li>{t('footerTerms2Point1')}</li>
                                        <li>{t('footerTerms2Point2')}</li>
                                    </ul>
                                </div>
                                <div>
                                    <p className="font-semibold">{t('footerTerms3Title')}</p>
                                     <ul className="list-disc list-inside pl-4 space-y-1">
                                        <li>{t('footerTerms3Point1')}</li>
                                        <li>{t('footerTerms3Point2')}</li>
                                    </ul>
                                </div>
                                <div>
                                    <p className="font-semibold">{t('footerTerms4Title')}</p>
                                    <ul className="list-disc list-inside pl-4 space-y-1">
                                        <li>{t('footerTerms4Point1')}</li>
                                        <li>{t('footerTerms4Point2')}</li>
                                        <li>{t('footerTerms4Point3')}</li>
                                    </ul>
                                </div>
                                <div>
                                    <p className="font-semibold">{t('footerTerms5Title')}</p>
                                    <p>{t('footerTerms5Point1')}</p>
                                     <ul className="list-disc list-inside pl-4 space-y-1">
                                        <li>{t('footerTerms5Point2')}</li>
                                        <li>{t('footerTerms5Point3')}</li>
                                    </ul>
                                </div>
                                <div>
                                    <p className="font-semibold">{t('footerTerms6Title')}</p>
                                    <p>{t('footerTerms6Point1')}</p>
                                </div>
                            </div>
                        </div>
                    </footer>
                </div>
            </div>
            );
        };
        
        // --- End of App.tsx content ---

        // --- Start of index.tsx mounting logic ---
        const rootElement = document.getElementById('root');
        if (rootElement) {
          const root = ReactDOM.createRoot(rootElement);
          root.render(
            <React.StrictMode>
              <App />
            </React.StrictMode>
          );
        } else {
          console.error("Could not find root element to mount to");
        }
    </script>
</body>
</html>
